{"version":3,"sources":["sqlite-gen.js","FileDropZone.js","QueryRunnner.js","ExportQuery.js","DateRule.js","CodingRule.js","IdRule.js","QuantityRule.js","Restrictions.js","Retention.js","BlockEditor.js","BlockChart.js","App.js","definitions.js","dm-example.js","store.js","index.js"],"names":["whereToSql","group","prefix","level","repeat","criteria","length","children","map","item","i","type","filter","g","join","buildField","definition","blockId","field","indexOf","select","id","prevFieldName","segments","match","forEach","segment","fieldName","replace","path","push","buildQuantity","r","comparator","gte","lte","gt","lt","eq","populated","not_populated","hasPredicate","compareTo","fixedValue","unitSystem","unitCode","split","fieldId","offset","offsetValue","offsetDir","buildCoding","where","codes","code","c","name","comment","system","buildCode","buildDate","target","offsetUnit","buildSql","blocks","outputCounts","hideComments","sql","sqlBlocks","block","fields","joinTargets","parentId","tableName","patientIdField","resourceIdField","rules","rule","fieldDefinition","find","f","restrictions","isLeaf","b","exclude","export","sourceDefinition","parseInt","retention","retentionType","retentionSortField","retentionSortDir","orderedBlocks","walkChildren","undefined","buildSqlBlocks","blockElements","Object","keys","joinBlockId","joinField","concat","fieldWhere","buildFn","coding","quantity","date","restriction","restrictionWhere","option","options","o","values","v","buildRestrictions","whereSql","selectSql","joinSql","innerSql","sqlBlock","wrapInTemporalFilter","commentText","expressions","wrapInTempTable","rootBlock","excludeBlocks","includeBlocks","buildTerminalQuery","selects","buildCountQuery","buildPatientListQuery","dropHint","fileDropHandler","useState","dragCounter","setDragCounter","isFileDrag","e","dataTransfer","types","overlay","className","style","border","backgroundColor","position","top","bottom","left","right","zIndex","onDragEnter","preventDefault","stopPropagation","onDragOver","onDragLeave","onDrop","files","QueryTester","props","useStoreon","dispatch","sqlState","setSqlState","dataSource","setDataSource","fileName","setFileName","db","setDb","dataSummary","setDataSummary","showDataDetail","setShowDataDetail","error","setError","fileInputRef","useRef","sqlite","hasLocalDb","useEffect","mode","show","current","then","initSqlJs","default","fetch","method","response","ok","loadBuiltInData","catch","console","log","window","setTimeout","Promise","resolve","reject","sqliteGen","exec","result","message","summarizeDb","tables","countSql","value","fhirToDb","fhir","newDb","Database","data","resourceType","_","chain","groupBy","mapValues","resources","rType","resourceStrings","JSON","stringify","flatten","fhirToSql","run","openDb","loadFile","file","extension","reader","FileReader","onerror","onloadend","size","records","trim","parse","Uint8Array","readAsText","readAsArrayBuffer","arrayBuffer","handleToggleDetail","ref","display","accept","onChange","Modal","background","animation","onHide","Header","closeButton","Title","Body","FileDropZone","Alert","variant","Form","Group","Control","as","Card","Button","onClick","click","href","Table","table","key","toString","Spinner","role","ExportQuery","copySuccess","setCopySuccess","textAreaRef","setSql","Row","Col","xs","Label","rows","defaultValue","readOnly","whiteSpace","Footer","document","execCommand","focus","Blob","textFileAsBlob","downloadLink","createElement","download","webkitURL","createObjectURL","URL","onclick","body","removeChild","appendChild","pp","setAttribute","encodeURIComponent","DateRule","compareTarget","handleChange","newData","invalid","test","validateDateProperties","onUpdate","mapOptions","property","simpleComparator","edit","hideControls","icon","faTrashAlt","opacity","onDelete","cursor","pull","invalidDate","validate","relativeOptions","sort","label","required","renderCompareTarget","renderOffset","findOption","compareToLabel","faEdit","lineHeight","toLowerCase","renderDisplay","CodingRule","validateCodingProperties","renderCustomEdit","renderHeader","placeholder","selection","codeCount","codeText","buildOptionDisplay","editable","renderOptionSelector","IdRule","targetLabel","paddingLeft","textIndent","QuantityRule","validateQuantityProperties","invalidValue","invalidUnitSystem","invalidUnitCode","getRuleDefaults","ruleData","defaults","Restrictions","setEdit","handleUpdateRule","pos","handleDeleteRule","ListGroup","ListGroupItem","fieldType","isCode","renderRule","Retention","retentionValue","retentionOptions","sortBy","handleVarChange","usedVars","retentionVar","handleValueChange","errors","renderEdit","BlockEditor","setName","setRetention","setRules","nextRuleId","setNextRuleId","isDirty","setIsDirty","dirtyWarning","setDirtyWarning","referenceWarning","setReferenceWarning","setDefinition","setValidate","handleSaveBlock","invalidRules","rs","onSave","handleClose","force","onClose","handleDeleteBlock","isReferenced","idJoinOptions","ddFields","DropdownButton","title","Dropdown","Item","d","addRule","renderRules","ruleId","newRule","hasErrors","backdrop","autoFocus","version","newRetention","definitions","action","BlockChart","patients","activeInstance","setActiveInstance","cells","blockList","node","bi","child","walkUp","span","walkDown","row","col","nextCol","colCount","reduce","acc","cell","Math","max","rowCount","saveBlock","insertAbove","deleteBlock","range","skip","height","cellStyles","retentionText","colSpan","Badge","renderCell","getRelativeOptions","renderModal","App","view","hasTestConfig","handleShowTest","Navbar","bg","Brand","Nav","inline","ButtonGroup","bind","Toggle","Menu","nextId","defaultState","store","createStoreon","on","location","search","dmExample","blockResults","ReactDOM","render","StrictMode","Provider","getElementById"],"mappings":"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","file":"static/js/main.bc71192f.chunk.js","sourcesContent":["import { connectStoreon } from \"storeon/react\";\n\nfunction sanitizeValue(value) { return value }\n\nfunction buildSqlBlocks(blocks) {\n\tlet sqlBlocks = {};\n\t\n\tblocks.forEach( block => {\n\n\t\tsqlBlocks[block.id] = sqlBlocks[block.id] || { \n\t\t\tfields: {}, joinTargets: {}, \n\t\t\tid: block.id, parentId: block.parentId, name: block.name,\n\t\t\ttableName: block.definition && block.definition.tableName,\n\t\t\tpatientIdField: block.definition && block.definition.patientIdField,\n\t\t\tresourceIdField: block.definition && (block.definition.resourceIdField || \"id\")\n\t\t};\n\n\t\tif (block.parentId !== null && !sqlBlocks[block.id].joinTargets[block.id] && block.parentId !== \"root\")\n\t\t\tsqlBlocks[block.id].joinTargets[block.parentId] = \"patient_id\";\n\n\t\t(block.rules || []).forEach( rule => {\n\t\t\tconst fieldDefinition = block.definition.fields.find( f => f.id === rule.fieldId );\n\t\t\tsqlBlocks[block.id].fields[rule.fieldId] = sqlBlocks[block.id].fields[rule.fieldId] || {};\n\t\t\t\n\t\t\tsqlBlocks[block.id].fields[rule.fieldId].restrictions = \n\t\t\t\tsqlBlocks[block.id].fields[rule.fieldId].restrictions || [];\n\t\t\tsqlBlocks[block.id].fields[rule.fieldId].restrictions.push(rule.restrictions);\n\n\t\t\tsqlBlocks[block.id].fields[rule.fieldId].definition = fieldDefinition;\n\n\t\t\tsqlBlocks[block.id].isLeaf = blocks.filter( b => b.parentId === block.id).length === 0;\n\t\t\tsqlBlocks[block.id].exclude = block.exclude; \n\t\t\t\n\t\t\trule.restrictions.forEach( r => {\n\t\t\t\tif (r.compareTo && r.compareTo !== \"fixed\" && r.compareTo !== \"run\" && r.comparator.indexOf(\"populated\") === -1) {\n\t\t\t\t\tconst [blockId, fieldId] = r.compareTo.split(\".\");\n\t\t\t\t\tsqlBlocks[blockId] = sqlBlocks[blockId] || { fields: {}, joinTargets: {} };\n\t\t\t\t\tsqlBlocks[blockId].fields[fieldId] = sqlBlocks[blockId].fields[fieldId]  || {};\n\t\t\t\t\tsqlBlocks[blockId].fields[fieldId].export = true;\n\t\t\t\t\tconst sourceDefinition = \n\t\t\t\t\t\tblocks.find( b => b.id === parseInt(blockId)).definition.fields.find( f => f.id === fieldId );\n\t\t\t\t\tsqlBlocks[blockId].fields[fieldId].definition = sourceDefinition;\n\t\t\t\t\tif (!sqlBlocks[block.id].joinTargets[blockId]) \n\t\t\t\t\t\tsqlBlocks[block.id].joinTargets[blockId] = \"patient_id\";\n\t\t\t\t} else if (r.target && fieldDefinition.type === \"fhirId\") {\n\t\t\t\t\tconst [blockId, fieldId] = r.target.split(\".\");\n\t\t\t\t\tsqlBlocks[block.id].joinTargets = sqlBlocks[block.id].joinTargets || {};\n\t\t\t\t\tsqlBlocks[block.id].joinTargets[blockId] = \"resource_id\";\n\t\t\t\t}\n\t\t\t})\n\t\t});\n\n\t\t// console.log(sqlBlocks)\n\t\tif (block.retention && block.retention.retentionType !== \"none\" && block.retention.retentionType !== \"all\") {\n\t\t\tconst fieldId = block.retention.retentionSortField;\n\t\t\tsqlBlocks[block.id].retentionSortField = fieldId;\n\t\t\tsqlBlocks[block.id].retentionSortDir = block.retention.retentionType === \"latest\" ? \"DESC\" : \"ASC\";\n\t\t\tif (!sqlBlocks[block.id].fields[fieldId]) {\n\t\t\t\tconst definition = block.definition.fields.find( f => f.id === fieldId);\n\t\t\t\tsqlBlocks[block.id].fields[fieldId] = {definition};\n\t\t\t}\n\t\t}\n\t})\n\n\tif (!sqlBlocks[\"root\"]) \n\t\tsqlBlocks[\"root\"] = {id: \"root\", tableName: \"Patient\", patientIdField: \"id\"}\n\n\tlet orderedBlocks = [];\n\tconst walkChildren = blockId => {\n\t\tif (blockId !== undefined && sqlBlocks[blockId])\n\t\t\torderedBlocks.push( sqlBlocks[blockId] );\n\t\tblocks.filter( b => b.parentId === blockId )\n\t\t\t.forEach( b => walkChildren(b.id) )\n\t}\n\twalkChildren(\"root\");\n\n\treturn orderedBlocks;\n}\n\nfunction whereToSql(group, prefix, level=0) {\n\n\tif (typeof group === \"string\") \n\t\treturn \"\\t\".repeat(level) + (prefix ? prefix + \" \" : \"\") + group;\n\n\tif (group.criteria.length === 0) \n\t\treturn;\n\n\tif (group.criteria.length === 1)\n\t\treturn whereToSql(group.criteria[0], level > 0 ? prefix : null , level);\n\n\tconst children = group.criteria.map( (item, i) => {\n\t\treturn whereToSql(item, i>0  ? group.type : null, level+1);\n\t}).filter( g => !!g );\n\n\tif (level === 0) \n\t\treturn children.join(\"\\n\");\n\n\tif (children.length)\n\t\treturn \"\\t\".repeat(level) + (prefix ? prefix + \" (\\n\" : \"(\\n\") + \n\t\t\tchildren.join(\"\\n\") + \n\t\t\t\"\\n\" + \"\\t\".repeat(level) + \")\"\n}\n\n\nfunction buildField(definition, blockId) {\n\n\tconst prefix = `f_${blockId}_`;\n\n\tif (definition.field.indexOf(\"[]\") === -1) return { \n\t\tselect: [`json_extract(res.json, '$.${definition.field}') ${prefix}${definition.id}`]\n\t}\n\n\tlet select = [];\n\tlet join = [];\n\n\tconst segments = definition.field.match(/[^\\[]+\\[\\]/g);\n\tlet prevFieldName;\n\tsegments.forEach( (segment, i) => {\n\t\tconst fieldName = prefix + (i < segments.length-1 \n\t\t\t? segment.replace(/\\[\\]/g, \"\").replace(/\\./g, \"_\") \n\t\t\t: definition.id\n\t\t);\n\t\tconst path = segment.replace(/(^\\.?)|(\\[\\]$)/g, \"\");\n\t\tjoin.push(`JOIN json_each(json_extract(${prevFieldName || \"res.json\"}, '$.${path}')) ${fieldName} ON 1=1`);\n\t\tprevFieldName = fieldName;\n\t});\n\n\tselect.push(`${prevFieldName}.value ${prevFieldName}`);\n\treturn { select, join }\n}\n\nfunction buildRestrictions(field, blockId) {\n\n\tconst buildFn = {\n\t\tcode: buildCode, coding: buildCoding, \n\t\tquantity: buildQuantity, date: buildDate\n\t}[field.definition.type];\n\n\tif (!buildFn) return;\n\n\tconst fieldName = \"f_\" + blockId + \"_\"  + field.definition.id;\n\tlet where = {type: \"AND\", criteria: []};\n\t\n\tfield.restrictions.forEach( restriction => {\n\t\tlet restrictionWhere = {type: \"OR\", criteria: []}\n\t\trestriction.forEach( r => {\n\t\t\tif (r.option) {\n\t\t\t\tconst values = field.definition.options.find( o => o.name === r.option).values;\n\t\t\t\tconst group = values.map( v => buildFn(v, fieldName) );\n\t\t\t\trestrictionWhere.criteria = restrictionWhere.criteria.concat(group);\n\t\t\t} else {\n\t\t\t\tconst group = buildFn(r, fieldName);\n\t\t\t\trestrictionWhere.criteria.push(group);\n\t\t\t}\n\t\t});\n\t\tif (restrictionWhere.criteria.length)\n\t\t\twhere.criteria.push(restrictionWhere);\n\t});\n\treturn where.criteria.length ? where : null;\n}\n\nfunction buildQuantity(r, fieldName) {\n\tconst comparator = {\n\t\tgte: \">= \", lte: \"<= \", gt: \"> \", lt: \"<  \", eq: \"= \", populated: \"IS NOT NULL\", not_populated: \"IS NULL\"\n\t}[r.comparator];\n\tconst hasPredicate = r.comparator.indexOf(\"populated\") === -1;\n\tconst isAbsolute = \n\t\tr.comparator === \"populated\" || r.comparator === \"not_populated\" || r.compareTo === \"fixed\";\n\tlet group = {type: \"AND\", criteria: [] };\n\n\tif (isAbsolute) {\n\t\tgroup.criteria.push(\n\t\t\t`json_extract(${fieldName}, '$.value') ${comparator + (hasPredicate ? r.fixedValue : \"\")}` \n\t\t)\n\t\tif (r.unitSystem) group.criteria.push(\n\t\t\t`json_extract(${fieldName}, '$.system') = '${sanitizeValue(r.unitSystem)}'`\n\t\t);\n\t\tif (r.unitCode) group.criteria.push(\n\t\t\t`json_extract(${fieldName}, '$.code') = '${sanitizeValue(r.unitCode)}'`\n\t\t);\n\t} else {\n\t\tconst [blockId, fieldId] = r.compareTo.split(\".\");\n\t\tconst offset = r.offsetValue ? `${r.offsetDir === \"minus\" ? + \"-\" : \"+\"} ${r.offsetValue}` : \"\";\n\t\tgroup.criteria.push(\n\t\t\t`json_extract(${fieldName}, '$.value') ${comparator} json_extract(block_${blockId}.f_${blockId}_${fieldId}, '$.value') ${offset}`,\n\t\t\t`(\n\t\t\t\t(json_extract(block_${blockId}.f_${blockId}_${fieldId}, '$.system') IS NULL AND json_extract(${fieldName}, '$.system') IS NULL)\n\t\t\t\tOR json_extract(${fieldName}, '$.system') = json_extract(block_${blockId}.f_${blockId}_${fieldId}, '$.system')\n\t\t\t)`,\n\t\t\t`(\n\t\t\t\t(json_extract(block_${blockId}.f_${blockId}_${fieldId}, '$.code') IS NULL AND json_extract(${fieldName}, '$.code') IS NULL)\n\t\t\t\tOR json_extract(${fieldName}, '$.code') = json_extract(block_${blockId}.f_${blockId}_${fieldId}, '$.code')\n\t\t\t)`\n\t\t);\n\t}\n\treturn group;\n}\n\nfunction buildCoding(r, fieldName) {\n\tlet where = {type: \"AND\", criteria: []}\n\tconst codes = r.code.split(/\\s*,\\s*/).map( c => `'${sanitizeValue(c)}'` ).join(\",\");\n\tif (r.name) where.comment = sanitizeValue(r.name)\n\tif (r.system) where.criteria.push(\n\t\t`json_extract(${fieldName}.value, '$.system') = '${sanitizeValue(r.system)}'`\n\t)\n\twhere.criteria.push(\n\t\t`json_extract(${fieldName}.value, '$.code') IN (${codes})`\n\t)\n\treturn where;\n}\n\nfunction buildCode(r, fieldName) {\n\treturn `${fieldName} = '${sanitizeValue(r.code)}'`;\n}\n\nfunction buildDate(r, fieldName) {\n\tconst comparator = {\n\t\tgte: \">= \", lte: \"<= \", gt: \"> \", lt: \"<  \", eq: \"= \", populated: \"IS NOT NULL\", not_populated: \"IS NULL\"\n\t}[r.comparator];\n\tconst hasPredicate = r.comparator.indexOf(\"populated\") === -1;\n\t\n\tconst isAbsolute = \n\t\tr.comparator === \"populated\" || r.comparator === \"not_populated\" || r.compareTo === \"fixed\";\n\tif (isAbsolute)\n\t\treturn `DATETIME(${fieldName}) ${comparator + (hasPredicate ? \"DATETIME('\" + r.fixedValue +\"')\" : \"\")}`;\n\n\tlet target;\n\tif (r.compareTo === \"run\") {\n\t\ttarget = \"'NOW'\"\n\t} else {\n\t\tconst [blockId, fieldId] = r.compareTo.split(\".\");\n\t\ttarget = `block_${blockId}.f_${blockId}_${fieldId}`;\n\t}\n\n\tif (r.offsetValue) {\n\t\tconst offset = `'${r.offsetDir === \"minus\" ? \"-\" : \"+\"}${r.offsetValue} ${r.offsetUnit}'`;\n\t\treturn `DATETIME(${fieldName}) ${comparator} DATETIME(${target}, ${offset})`;\n\t} else {\n\t\treturn `DATETIME(${fieldName}) ${comparator} DATETIME(${target})`;\n\t}\n}\n\nfunction wrapInTemporalFilter(sqlBlock, sql) {\n\treturn `SELECT outer.* FROM (\n\t\tSELECT inner.*,\n\t\t\tdense_rank() over (\n\t\t\t\tpartition by inner.f_${sqlBlock.id}_patient_id\n\t\t\t\torder by inner.f_${sqlBlock.id}_${sqlBlock.retentionSortField} ${sqlBlock.retentionSortDir}\n\t\t\t) as rank\n\t\t\tFROM (\n\t\t\t\t${sql.replace(/\\n/g, \"\\n\\t\\t\\t\\t\")}\n\t\t\t) AS inner\n) AS outer WHERE outer.rank = 1`\n}\n\nfunction wrapInTempTable(id, sql, commentText) {\n\tlet expressions = commentText ? [\"-- \" + commentText] : [];\n\texpressions.push(\n\t\t`DROP TABLE IF EXISTS block_${id};`,\n\t\t`CREATE TEMPORARY TABLE block_${id} AS`,\n\t\t`${sql};`\n\t)\n\treturn expressions.join(\"\\n\");\n}\n\nfunction buildTerminalQuery(sqlBlocks) {\n\n\tconst rootBlock = sqlBlocks.find( b => b.id === \"root\" );\n\tconst excludeBlocks = sqlBlocks.filter( b => b.isLeaf && b.exclude );\n\tconst includeBlocks = sqlBlocks.filter( b => b.isLeaf && !b.exclude );\n\n\tlet select;\n\tif (excludeBlocks && !includeBlocks.length) {\n\t\tselect = [\n\t\t\t`SELECT DISTINCT(json_extract(res.json, '$.${rootBlock.patientIdField || \"id\"}')) list_patient_id \\nFROM ${rootBlock.tableName} res`\n\t\t]\n\t} else if (includeBlocks.length) {\n\t\tselect = includeBlocks.map( (b, i) => {\n\t\t\treturn `${i > 0 ? \"UNION \" : \"\"}SELECT DISTINCT(block_${b.id}.f_${b.id}_patient_id) list_patient_id FROM block_${b.id}`;\n\t\t})\n\t}\n\n\tselect = select.concat( excludeBlocks.map( b => {\n\t\treturn `EXCEPT SELECT DISTINCT(block_${b.id}.f_${b.id}_patient_id) list_patient_id FROM block_${b.id}`;\n\t}) );\n\n\treturn [\n\t\t`-- Patient List`,\n\t\t`DROP TABLE IF EXISTS patient_list;`, \n\t\t`CREATE TEMPORARY TABLE patient_list AS`\n\t].concat(select).join(\"\\n\")+\";\";\n}\n\nfunction buildCountQuery(sqlBlocks) {\n\tconst rootBlock = sqlBlocks.find( b => b.id === \"root\" );\n\tif (!rootBlock) return;\n\n\tlet selects = [\n\t\t`SELECT 'root' block, COUNT(DISTINCT json_extract(${rootBlock.tableName}.json, '$.${rootBlock.patientIdField || \"id\"}')) patients FROM ${rootBlock.tableName}`,\n\t\t`SELECT 'result' block, COUNT(DISTINCT list_patient_id) patients FROM patient_list`,\n\t];\n\tsqlBlocks.forEach( block => {\n\t\tif (block.id === \"root\") return;\n\t\tselects.push(`SELECT ${block.id} block, COUNT(DISTINCT f_${block.id}_patient_id) patients FROM block_${block.id}`)\n\t});\n\tconst comment = \"-- Block Counts\\n\";\n\treturn comment + selects.join(\"\\nUNION ALL\\n\") + \";\";\n}\n\nfunction buildPatientListQuery(sqlBlocks) {\n\tconst rootBlock = sqlBlocks.find( b => b.id === \"root\" );\n\tif (!rootBlock) return;\n\n\treturn `SELECT list_patient_id, ${rootBlock.tableName}.json FROM patient_list\n\t\tINNER JOIN ${rootBlock.tableName}\n\t\tON patient_list.list_patient_id = json_extract(${rootBlock.tableName}.json, '$.${rootBlock.patientIdField || \"id\"}');`\n}\n\nfunction buildSql(blocks, outputCounts, hideComments) {\n\tlet sql = [];\n\n\tconst sqlBlocks = buildSqlBlocks(blocks);\n\n\tsqlBlocks.forEach( block => {\n\n\t\tif (!block.tableName || block.parentId === undefined) return;\n\n\t\tlet blockElements = {join: [], select: [], where: []};\n\n\t\tObject.keys(block.joinTargets).forEach( joinBlockId => {\n\t\t\tconst joinField = block.joinTargets[joinBlockId];\n\t\t\tblockElements.join.push( \n\t\t\t\t`INNER JOIN block_${joinBlockId} ON block_${joinBlockId}.f_${joinBlockId}_${joinField} = f_${block.id}_${joinField}`\n\t\t\t)\n\t\t});\n\n\t\tblockElements.select.push(\n\t\t\tbuildField({field: block.patientIdField || \"subject.reference\", id: \"patient_id\"}, block.id).select,\n\t\t\tbuildField({field: block.resourceIdField || \"id\", id: \"resource_id\"}, block.id).select,\n\t\t);\n\n\t\tObject.keys(block.fields).forEach( fieldId => {\n\t\t\tconst field = block.fields[fieldId];\n\t\t\t//fhirIds are handled as a joinTarget above\n\t\t\tif (field.type === \"fhirId\") return;\n\n\t\t\tconst {join, select} = buildField(field.definition, block.id);\n\t\t\tif (join)\n\t\t\t\tblockElements.join = blockElements.join.concat(join);\n\t\t\tif (select)\n\t\t\t\tblockElements.select = blockElements.select.concat(select);\n\t\t\tif (field.restrictions) {\n\t\t\t\tconst fieldWhere = buildRestrictions(field, block.id);\n\t\t\t\tif (fieldWhere) blockElements.where.push(fieldWhere);\t\n\t\t\t};\n\t\t});\n\n\t\tconst whereSql = blockElements.where.length\n\t\t\t? whereToSql({type: \"AND\", criteria: blockElements.where})\n\t\t\t: \"\";\n\t\n\t\tconst selectSql = blockElements.select.join(\",\\n\\t\");\n\t\tconst joinSql = blockElements.join.join(\"\\n\\t\");\n\n\t\tlet innerSql = `SELECT\\n\\t${selectSql}\\nFROM\\n\\t${block.tableName} res` +\n\t\t\t(joinSql.length ? `\\n\\t${joinSql}` : \"\") +\n\t\t\t(whereSql.length ? `\\nWHERE\\n\\t${whereSql}` : \"\");\n\n\t\tif (block.retentionSortField) innerSql = \n\t\t\twrapInTemporalFilter(block, innerSql);\n\n\t\tconst commentText = !hideComments ? sanitizeValue(block.name) : null;\n\t\tsql.push(wrapInTempTable(block.id, innerSql, commentText));\n\n\t})\n\t\n\tsql.push( buildTerminalQuery(sqlBlocks) )\n\n\tif (outputCounts) {\n\t\tsql.push( buildCountQuery(sqlBlocks) )\n\t} else {\n\t\tsql.push( buildPatientListQuery(sqlBlocks) )\n\t}\n\t\n\treturn sql.join(\"\\n\\n\");\n}\n\nexport default {\n\tbuildSql, whereToSql, buildDate, \n\tbuildQuantity, buildCode, buildCoding\n}","import React, { useState } from \"react\";\n\nexport default ({ children, dropHint, fileDropHandler }) => {\n\n\tconst [dragCounter, setDragCounter] = useState(0);\n\n\tconst isFileDrag = e => {\n\t\treturn !e.dataTransfer.types ||\n\t\t\te.dataTransfer.types[0] === \"Files\" ||\n\t\t\te.dataTransfer.types[0] === \"application/x-moz-file\";\n\t}\n\t\n\tconst handleDrop = e => {\n\t\te.preventDefault();\n\t\te.stopPropagation();\n\t\tif (e.dataTransfer.files && e.dataTransfer.files.length === 1)\n\t\t\tfileDropHandler(e.dataTransfer.files[0]);\n\t\t// e.dataTransfer.clearData();\n\t\tsetDragCounter(0);\n\t}\n\n\tconst handleDragOver = e => {\n\t\te.preventDefault();\n\t\te.stopPropagation();\t\n\t}\n\n\tconst handleDragEnter = e => {\n\t\te.preventDefault();\n\t\te.stopPropagation();\n\t\tif (isFileDrag(e))\n\t\t\tsetDragCounter(dragCounter+1);\n\t}\n\n\tconst handleDragLeave = e => {\n\t\te.preventDefault();\n\t\te.stopPropagation();\n\t\tif (isFileDrag(e))\n\t\t\tsetDragCounter(dragCounter-1);\n\t}\n\n\tconst overlay = <div className=\"d-flex justify-content-center\" style={{\n\t\tborder: 'dashed grey 4px',\n\t\tbackgroundColor: 'rgba(255,255,255,.8)',\n\t\tposition: 'absolute',\n\t\ttop: 0,\n\t\tbottom: 0,\n\t\tleft: 0, \n\t\tright: 0,\n\t\tzIndex: 9999,\n\t}}>\n\t\t<div className=\"d-flex align-items-center\">\n\t\t\t{ dropHint || \"Drop NDJSON or SQLITE DB file here\"}\n\t\t</div>\n\t</div>\n\n\treturn <div \n\t\tstyle={{position: \"relative\"}}\n\t\t\tonDragEnter={handleDragEnter}\n\t\t\tonDragOver={handleDragOver}\n\t\t\tonDragLeave={handleDragLeave}\n\t\t\tonDrop={handleDrop}\n\t\t>\n\t\t{ dragCounter > 0 && overlay }\n\t\t{ children }\n\t</div>\n\t\n\t\n} \t","import { useStoreon } from \"storeon/react\";\nimport React, { useEffect, useState, useRef } from 'react';\nimport {Modal, Button, Alert, Spinner, Table, Card, Form} from 'react-bootstrap';\nimport _ from 'lodash';\n\nimport sqliteGen from \"./sqlite-gen\";\nimport FileDropZone from \"./FileDropZone\";\n\nfunction QueryTester(props) {\n\t\n\tconst {blocks, dispatch} = useStoreon(\"blocks\");\n\n\tconst [sqlState, setSqlState] = useState(\"loading_sqlite\");\n\tconst [dataSource, setDataSource] = useState(\"local\"); //built-in\n\tconst [fileName, setFileName] = useState();\n\tconst [db, setDb] = useState();\n\tconst [dataSummary, setDataSummary] = useState();\n\tconst [showDataDetail, setShowDataDetail] = useState();\n\tconst [error, setError] = useState();\n\tconst fileInputRef = useRef(null);\n\t\n\tconst sqlite = useRef();\n\tconst hasLocalDb = useRef();\n\n\tuseEffect( () => {\n\t\tif (props.mode === \"test-run\")\n\t\t\treturn setSqlState(\"running_query\");\n\n\t\tif (!props.show || sqlite.current) return;\n\n\t\timport(\"./sql-wasm-json1\").then( initSqlJs => {\n\t\t\tsqlite.current = initSqlJs.default();\n\t\t\tsqlite.current.then( () => {\n\t\t\t\treturn fetch(\"bulk.db\", {method: \"HEAD\"})\n\t\t\t}).then( response => {\n\t\t\t\thasLocalDb.current = !!response.ok;\n\t\t\t\tif (hasLocalDb.current && dataSource === \"built-in\") {\n\t\t\t\t\tloadBuiltInData();\n\t\t\t\t} else {\n\t\t\t\t\tsetDataSource(\"local\");\n\t\t\t\t\tsetSqlState(\"no_data\");\n\t\t\t\t}\n\t\t\t}).catch( e => {\n\t\t\t\tconsole.log(e);\n\t\t\t\tsetError(\"Error loading SQL engine\");\n\t\t\t\tsetSqlState(\"error\");\n\t\t\t});\n\t\t});\n\t}, [props.show]);\n\n\n\tuseEffect( () => {\n\t\tif (sqlState === \"running_query\")\n\t\t\t//this is ugly but seems necessary to allow time for browser to redraw screen\n\t\t\twindow.setTimeout( () => {\n\t\t\t\tnew Promise( (resolve, reject) => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst sql = sqliteGen.buildSql(blocks, true);\n\t\t\t\t\t\tconst result = db.exec(sql);\n\t\t\t\t\t\tresolve(result)\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treject(e);\n\t\t\t\t\t};\n\t\t\t\t}).then( result => {\n\t\t\t\t\tsetSqlState(\"data_loaded\");\n\t\t\t\t\tdispatch(\"patients/set\", result);\n\t\t\t\t}).then( () => {\n\t\t\t\t\tdispatch(\"view/set\", \"blocks\");\n\t\t\t\t}).catch( e => {\n\t\t\t\t\tsetError(\"Query failed: \" + e.message);\n\t\t\t\t\tsetSqlState(\"error\");\n\t\t\t\t})\n\t\t\t}, 500)\n\t}, [sqlState])\n\n\tif (!props.show) return null;\n\n\tconst fhirToSql = data => {\n\t\tif (!data.find(r => r.resourceType === \"Patient\"))\n\t\t\tthrow({message: \"No patient resources found\"});\n\t\treturn _.chain(data)\n\t\t\t.groupBy(\"resourceType\")\n\t\t\t.mapValues( (resources, rType) => {\n\t\t\t\tconst resourceStrings = resources.map( r => \"('\" +JSON.stringify(r) + \"')\")\n\t\t\t\treturn [\n\t\t\t\t\t`CREATE TABLE ${rType}(json)`,\n\t\t\t\t\t`INSERT INTO ${rType} VALUES ${resourceStrings.join(\",\")}`\n\t\t\t\t]\n\t\t\t}).values().flatten().join(\"; \").value();\n\t} \n\n\tconst summarizeDb = (db) => {\n\t\tconst tables = db.exec(\n\t\t\t`SELECT name FROM sqlite_master\n\t\t\tWHERE type = 'table' AND name NOT LIKE 'sqlite_%'\n\t\t\tORDER BY name asc\n\t\t`);\n\t\tif (!tables[0]) throw {message: \"No tables found\"}\n\t\tconst countSql = tables[0].values.map( value => {\n\t\t\treturn `SELECT '${value[0]}' name, COUNT() records FROM ${value[0]}`\n\t\t});\n\t\tconst counts = db.exec(countSql.join(\" UNION ALL \"))\n\t\treturn counts[0].values;\n\t}\n\n\tconst fhirToDb = fhir => {\n\t\tsqlite.current.then( sqlite => {\n\t\t\tconst newDb = new sqlite.Database();\n\t\t\tconst sql = fhirToSql(fhir);\n\t\t\tnewDb.run(sql);\n\t\t\tsetDataSummary(summarizeDb(newDb));\n\t\t\tsetSqlState(\"data_loaded\");\n\t\t\tdispatch(\"hasTestConfig/set\", true);\n\t\t\tsetDb(newDb)\n\t\t}).catch( e => {\n\t\t\tconsole.log(e);\n\t\t\tsetError(\"Error loading FHIR data: \" + e.message);\n\t\t\tsetFileName(null);\n\t\t\tsetSqlState(\"error\");\n\t\t});\n\t}\n\n\tconst openDb = data => {\n\t\tsqlite.current.then( sqlite => {\n\t\t\tconst newDb = new sqlite.Database(data);\n\t\t\tsetDataSummary(summarizeDb(newDb));\n\t\t\tsetDb(newDb)\n\t\t\tsetSqlState(\"data_loaded\");\n\t\t\tdispatch(\"hasTestConfig/set\", true);\n\t\t}).catch( e => {\n\t\t\tconsole.log(e);\n\t\t\tsetError(\"Error loading FHIR data: \" + e.message);\n\t\t\tsetFileName(null);\n\t\t\tsetSqlState(\"error\");\n\t\t});\n\t}\n\n\tconst loadFile = file => {\n\t\tconst extension = file.name.split(\".\")[file.name.split(\".\").length-1];\n\t\tsetFileName(file.name);\n\t\tsetSqlState(\"loading_data\");\n\t\tsetDataSource(\"local\");\n\n\t\tconst reader = new FileReader();\n\t\treader.onerror = e => {\n\t\t\tsetFileName(null);\n\t\t\tsetError(\"Error reading data file\");\n\t\t\tsetSqlState(\"error\");\n\t\t};\n\t\treader.onloadend = e => {\n\t\t\tif (file.size > 1000000 && extension === \"ndjson\") {\n\t\t\t\tsetFileName(null);\n\t\t\t\tsetError(\"File is too large - please limit NDJSON files to size to 1mb\");\n\t\t\t\tsetSqlState(\"error\");\n\t\t\t} else if (extension === \"ndjson\") {\n\t\t\t\tconst records = e.target.result\n\t\t\t\t\t.replace(/\\'/g, \"''\")\n\t\t\t\t\t.trim().split(\"\\n\")\n\t\t\t\t\t.map( r => JSON.parse(r));\n\t\t\t\tfhirToDb(records);\n\t\t\t} else {\n\t\t\t\tconst data = new Uint8Array(reader.result);\n\t\t\t\topenDb(data);\n\t\t\t}\n\t\t}\n\t\tif (extension === \"ndjson\") {\n\t\t\treader.readAsText(file);\n\t\t} else {\n\t\t\treader.readAsArrayBuffer(file);\n\t\t}\n\t}\n\n\tconst loadBuiltInData = () => {\n\t\tsetSqlState(\"loading_data\");\n\t\tfetch(\"bulk.db\").then( response => {\n\t\t\treturn response.arrayBuffer();\n\t\t})\n\t\t.then( arrayBuffer => {\n\t\t\tconst data = new Uint8Array(arrayBuffer);\n\t\t\topenDb(data);\n\t\t})\n\t\t.catch( error => {\n\t\t\tconsole.log(error);\n\t\t\tsetError(\"Error reading data file\");\n\t\t\tsetSqlState(\"error\");\n\t\t});\n\t}\n\n\tconst handleHide = e => {\n\t\tif (sqlState === \"loading_sqlite\" || sqlState === \"loading_data\" || sqlState === \"running_query\")\n\t\t\treturn false;\n\t\tdispatch(\"view/set\", \"blocks\")\n\t}\n\n\tconst handleFileChange = e => {\n\t\tconst file = fileInputRef.current.files[0];\n\t\tif (file) loadFile(file);\n\t}\n\n\tconst handleSetData = e => {\n\t\tfileInputRef.current.click();\n\t}\n\n\tconst handleRunQuery = e => {\n\t\tsetSqlState(\"running_query\");\n\t}\n\n\tconst handleDataSourceChange = e => {\n\t\tif (e.target.value === \"built-in\") {\n\t\t\tsetDataSource(\"built-in\");\n\t\t\tloadBuiltInData();\n\t\t} else {\n\t\t\tsetDataSource(\"local\");\n\t\t\tsetSqlState(\"no_data\");\n\t\t\tdispatch(\"hasTestConfig/set\", false);\n\t\t}\n\t}\n\n\tconst handleToggleDetail = (e, show) => {\n\t\te.preventDefault();\n\t\tsetShowDataDetail(show);\n\t}\n\n\t// console.log(sqlState)\n\n\treturn <div>\n\t\t<input type=\"file\" ref={fileInputRef} style={{display: \"none\"}} accept=\".ndjson,.sqlite,.db\" onChange={handleFileChange}/>\n\t\t<Modal background=\"static\" show={true} animation={false} size=\"lg\" onHide={handleHide}>\n\t\t\t<Modal.Header closeButton>\n\t\t\t\t<Modal.Title>Test Query</Modal.Title>\n\t\t\t</Modal.Header>\n\t\t\t<Modal.Body><FileDropZone fileDropHandler={loadFile}>\n\n\t\t\t\t{sqlState === \"error\" && \n\t\t\t\t\t<Alert variant=\"danger\">{error}</Alert>\n\t\t\t\t}\n\n\t\t\t\t{sqlState !== \"loading_data\" && sqlState !== \"running_query\" && sqlState !== \"loading_sqlite\" && <div>\n\n\t\t\t\t\t<Form.Group>\n\t\t\t\t\t\t<Form.Control as=\"select\" value={dataSource} onChange={handleDataSourceChange}>\n\t\t\t\t\t\t\t<option value=\"local\">Local Dataset</option>\n\t\t\t\t\t\t\t{hasLocalDb.current && <option value=\"built-in\">Test Dataset</option>}\n\t\t\t\t\t\t</Form.Control>\n\t\t\t\t\t</Form.Group>\n\n\t\t\t\t\t{ dataSource === \"local\" && \n\t\t\t\t\t\t<Card><Card.Body>\n\t\t\t\t\t\t\t<div className=\"font-weight-bold mb-2\">\n\t\t\t\t\t\t\t\tA3 Annotated FHIR Data (NDJSON or SQLITE DB)\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<Button size=\"sm\" variant=\"success\" onClick={handleSetData} className=\"mr-2\">\n\t\t\t\t\t\t\t\t\t{fileName ? \"Change File\" : \"Choose File\"}\n\t\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t\t<span>{fileName}</span>\t\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</Card.Body></Card>\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t</div>\n\t\t\t\t}\n\n\n\t\t\t\t{sqlState === \"data_loaded\" && dataSummary && !showDataDetail &&\n\t\t\t\t\t <div className=\"m-2\"><a href=\"#\" onClick={e => handleToggleDetail(e, true)}>show detail</a></div>\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t{sqlState === \"data_loaded\" && dataSummary && showDataDetail && <div className=\"mx-4\">\n\t\t\t\t\t<Table size=\"sm\">\n\t\t\t\t\t\t<thead><tr className=\"font-weight-bold\"><td>Resource</td><td className=\"text-right\">Records</td></tr></thead>\n\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\t{dataSummary.map( table => <tr key={table[0]}>\n\t\t\t\t\t\t\t\t<td>{table[0]}</td>\n\t\t\t\t\t\t\t\t<td className=\"text-right\">{table[1].toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, \",\")}</td>\n\t\t\t\t\t\t\t</tr>)}\n\t\t\t\t\t\t</tbody>\n\t\t\t\t\t</Table>\n\t\t\t\t\t<a href=\"#\" onClick={handleToggleDetail} className=\"mt-1\">hide detail</a>\n\t\t\t\t</div>}\n\n\t\t\t\t{(sqlState === \"loading_sqlite\" || sqlState === \"loading_data\" || sqlState === \"running_query\") &&\n\t\t\t\t\t<div className=\"my-2 text-center\">\n\t\t\t\t\t\t<Spinner animation=\"border\" role=\"status\" />\n\t\t\t\t\t\t{sqlState !== \"loading_sqlite\" &&\n\t\t\t\t\t\t\t<div className=\"mt-1 font-weight-bold\">\n\t\t\t\t\t\t\t\t{sqlState === \"loading_data\" ? \"Loading Data\" : \"Running Query\"}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t}\n\t\t\t\t\t</div>\n\t\t\t\t}\n\n\t\t\t\t{sqlState === \"data_loaded\" &&\n\t\t\t\t\t<div className=\"m-2 mt-4 text-right\">\n\t\t\t\t\t\t{sqlState === \"data_loaded\" && <Button onClick={handleRunQuery}>Run Query!</Button>}\n\t\t\t\t\t</div>\t\t\t\t\n\t\t\t\t}\n\n\t\t\t</FileDropZone></Modal.Body>\n\t\t</Modal>\n\t</div>\n}\n\nexport default QueryTester;","import React, { useState, useRef, useEffect } from 'react';\nimport { useStoreon } from \"storeon/react\";\nimport {Modal, Form, Row, Col, Button} from 'react-bootstrap';\nimport sqliteGen from \"./sqlite-gen\";\n\nfunction ExportQuery() {\n\n\tconst {blocks, dispatch} = useStoreon([\"blocks\"]);\n\n\tconst [copySuccess, setCopySuccess] = useState();\n\tconst [show, setShow] = useState(true);\n\tconst textAreaRef = useRef(null);\n\tconst [sql, setSql] = useState();\n\n\tuseEffect( () => {\n\t\tsetSql( sqliteGen.buildSql(blocks, true) );\n\t}, []);\n\n\tconst handleCopyToClipboard = e => {\n\t\ttextAreaRef.current.select();\n\t\tdocument.execCommand('copy');\n\t\te.target.focus();\n\t\tsetCopySuccess('Copied!');\n\t}\n\n\tconst handleDownload = e => {\n\t\t//per https://stackoverflow.com/questions/30864573/what-is-a-blob-url-and-why-it-is-used\n\t\tconst fileName = \"query.sql\";\n\t\t\tif (typeof(Blob) != 'undefined') {\n\t\t\tconst textFileAsBlob = new Blob([sql], {type: 'text/plain'});\n\t\t\tconst downloadLink = document.createElement(\"a\");\n\t\t\tdownloadLink.download = fileName;\n\t\t\tif (window.webkitURL != null) {\n\t\t\t\tdownloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);\n\t\t\t} else {\n\t\t\t\tdownloadLink.href = window.URL.createObjectURL(textFileAsBlob);\n\t\t\t\tdownloadLink.onclick = e => document.body.removeChild(e.target);\n\t\t\t\tdownloadLink.style.display = \"none\";\n\t\t\t\tdocument.body.appendChild(downloadLink);\n\t\t\t}\n\t\t\tdownloadLink.click();\n\t\t} else {\n\t\t\tvar pp = document.createElement('a');\n\t\t\tpp.setAttribute('href', 'data:text/plain;charset=utf-8,' +\n\t\t\t\tencodeURIComponent(sql));\n\t\t\tpp.setAttribute('download', fileName);\n\t\t\tpp.onclick = e => document.body.removeChild(e.target);\n\t\t\tpp.click();\n\t\t}\n\t}\n\n\tconst handleDbChange = e => {\n\t\tsetCopySuccess(\"\");\n\t}\n\n\treturn <Modal show={true} animation={false} size=\"lg\" onHide={e => dispatch(\"view/set\", \"blocks\")}>\n\t\t<Modal.Header closeButton>\n\t\t\t<Modal.Title>Export SQL</Modal.Title>\n\t\t</Modal.Header>\n\t\t<Modal.Body>\n\t\t\t<Form.Group as={Row} className=\"align-items-center\">\n\t\t\t\t<Col xs=\"auto\">\n\t\t\t\t\t<Form.Label>Format</Form.Label>\n\t\t\t\t</Col>\n\t\t\t\t<Col>\n\t\t\t\t\t<Form.Control as=\"select\" onChange={handleDbChange}>\n\t\t\t\t\t\t<option>Sqlite</option>\n\t\t\t\t\t</Form.Control>\n\t\t\t\t</Col>\n\t\t\t</Form.Group>\n\t\t\t<Form.Control as=\"textarea\" rows={6} ref={textAreaRef} defaultValue={sql} readOnly \n\t\t\t\tstyle={{backgroundColor:\"#FFF\", \"fontFamily\": \"monospace,monospace\", whiteSpace: \"pre\"}}\n\t\t\t/>\n\t\t</Modal.Body>\n\t\t<Modal.Footer className=\"align-items-center\">\n\t\t\t<div className=\"mr-auto my-auto ml-2\">{copySuccess}</div>\n\t\t\t<Button variant=\"outline-primary\" onClick={handleCopyToClipboard}>Copy to Clipboard</Button>\n\t\t\t<Button onClick={handleDownload}>Download</Button>\n\t\t</Modal.Footer>\n\t</Modal>\n}\n\nexport default ExportQuery;","import React from 'react';\nimport { Col }  from \"react-bootstrap\";\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome'\nimport { faEdit, faTrashAlt } from '@fortawesome/free-solid-svg-icons'\n\n\nfunction DateRule(props) {\n\tconst options = {\n\t\tcomparator: [\n\t\t\t{value: \"populated\", display: \"Populated\"},\n\t\t\t{value: \"not_populated\", display: \"Not Populated\"},\n\t\t\t{value: \"eq\", display: \"Equal To\"},\n\t\t\t{value: \"lt\", display: \"Before\"},\n\t\t\t{value: \"lte\", display: \"Before (Inclusive)\"},\n\t\t\t{value: \"gt\", display: \"After\"},\n\t\t\t{value: \"gte\", display: \"After (Inclusive)\"}\n\t\t],\n\t\tcompareTarget: [\n\t\t\t{value: \"run\", display: \"Query Run Date\"},\n\t\t\t{value: \"fixed\", display: \"Fixed Date\"}\n\t\t],\n\t\toffsetDir: [\n\t\t\t{value: \"plus\", display: \"+\"},\n\t\t\t{value: \"minus\", display: \"-\"}\n\t\t],\n\t\toffsetUnit: [\n\t\t\t{value: \"minutes\", display: \"Minutes\"},\n\t\t\t{value: \"hours\", display: \"Hours\"},\n\t\t\t{value: \"days\", display: \"Days\"},\n\t\t\t{value: \"months\", display: \"Months\"},\n\t\t\t{value: \"years\", display: \"Years\"}\n\t\t]\n\t}\n\n\tconst handleChange = (field, value) => {\n\t\tconst newData = {...props.data, [field]: value};\n\t\tconst invalid = validateDateProperties(newData);\n\t\tprops.onUpdate({...newData, invalid});\n\t}\n\n\tconst mapOptions = (property) => {\n\t\treturn options[property].map( o => {\n\t\t\treturn <option value={o.value} key={o.value}>{o.display}</option>\n\t\t});\n\t};\n\n\tconst renderHeader = () => <div className=\"my-2\">\n\t\t<span className=\"mr-1 font-weight-bold\">{props.fieldDefinition.name || props.fieldDefinition.id}</span>\n\t\t<span>is</span>\n\t\t{!props.hideControls && <FontAwesomeIcon \n\t\t\ticon={faTrashAlt} opacity=\"0.5\"\n\t\t\tonClick={e => props.onDelete(props.id)} \n\t\t\tstyle={{cursor: \"pointer\"}} \n\t\t\tpull=\"right\" \n\t\t/>}\n\t</div>\n\n\tconst renderComparator = () => <div className=\"my-2\">\n\t\t<select className=\"form-control\"\n\t\t\tvalue={props.data.comparator || \"gt\"} \n\t\t\tonChange={e => handleChange(\"comparator\", e.target.value)}\n\t\t>{mapOptions(\"comparator\")}</select>\n\t</div>\n\n\tconst renderCompareTarget = () => {\n\t\tconst invalidDate = props.data.validate && props.data.invalid;\n\t\treturn <div className=\"my-2 form-row\">\n\t\t\t<Col>\n\t\t\t\t<select className=\"form-control\"\n\t\t\t\t\tvalue={props.data.compareTo || \"fixed\"} \n\t\t\t\t\tonChange={e => handleChange(\"compareTo\", e.target.value)}\n\t\t\t\t>{mapOptions(\"compareTarget\")}\n\t\t\t\t\t{(props.relativeOptions || []).sort().map( r => {\n\t\t\t\t\t\treturn <option key={r.value} value={r.value}>{r.label}</option>\n\t\t\t\t\t})}\n\t\t\t\t</select>\n\t\t\t</Col>\n\t\t\t{(!props.data.compareTo || props.data.compareTo === \"fixed\") && <Col>\n\t\t\t\t<input type=\"date\" className=\"form-control\"\n\t\t\t\t\trequired={true} \n\t\t\t\t\tvalue={props.data.fixedValue || \"\"} \n\t\t\t\t\tonChange={e => handleChange(\"fixedValue\", e.target.value)}\n\t\t\t\t\tclassName={invalidDate ? \"is-invalid form-control\" : \"form-control\"}\n\t\t\t\t/>\n\t\t\t</Col>}\n\t\t</div>\n\t}\n\n\tconst renderCompareOffset = () => <div className=\"my-2 form-row\"><Col>\n\t\t<select className=\"form-control\"\n\t\t\tvalue={props.data.offsetDir || \"plus\"} \n\t\t\tonChange={e => handleChange(\"offsetDir\", e.target.value)}\n\t\t>{mapOptions(\"offsetDir\")}</select>\n\t</Col><Col>\n\t\t<input type=\"number\" className=\"form-control\"\n\t\t\tvalue={props.data.offsetValue || \"\"}  required={true}\n\t\t\tonChange={e => handleChange(\"offsetValue\", e.target.value)}\n\t\t/>\n\t</Col><Col>\n\t\t<select className=\"form-control\"\n\t\t\tvalue={props.data.offsetUnit || \"years\"} \n\t\t\tonChange={e => handleChange(\"offsetUnit\", e.target.value)}\n\t\t>{mapOptions(\"offsetUnit\")}</select>\n\t</Col></div>\n\n\tconst simpleComparator = props.data.comparator &&\n\t\tprops.data.comparator.indexOf(\"populated\") !== -1;\n\n\tconst renderDisplay = () => {\n\n\t\tconst renderOffset = () => {\n\t\t\tif (!props.data.offsetValue) return;\n\t\t\treturn <span className=\"mr-1 mt-1 mark\">\n\t\t\t\t{findOption(\"offsetDir\", props.data.offsetDir)}\n\t\t\t\t{\" \"}{props.data.offsetValue}{\" \"}\n\t\t\t\t{findOption(\"offsetUnit\", props.data.offsetUnit)}\n\t\t\t</span>\n\t\t};\n\n\t\tconst findOption = (property, value) => {\n\t\t\treturn options[property].find( o => o.value === value).display;\n\t\t}\n\n\t\tconst compareToLabel = !simpleComparator && props.data.compareTo.indexOf(\".\") > -1 &&\n\t\t\tprops.relativeOptions.find( r => r.value === props.data.compareTo ).label;\n\n\t\treturn <div>\n\t\t\t{!props.hideControls && \n\t\t\t\t<FontAwesomeIcon icon={faEdit} opacity=\"0.5\" style={{cursor: \"pointer\"}} pull=\"right\" className=\"m-1\" />\n\t\t\t}\n\t\t\t\n\t\t\t<div style={{lineHeight: 2}}>\n\t\t\t\t<span className=\"mt-1 mr-1 font-weight-bold\">{props.fieldDefinition.name || props.fieldDefinition.id}</span>\n\t\t\t\t<span className=\"mt-1 mr-1\">is</span>\n\t\t\t\t<span className=\"mt-1 mr-1 mark\">\n\t\t\t\t\t{findOption(\"comparator\", props.data.comparator).toLowerCase()}\n\t\t\t\t</span>\n\n\t\t\t\t{!simpleComparator && props.data.compareTo === \"fixed\" && <>\n\t\t\t\t\t<span className=\"mt-1 mr-1 mark\">fixed value</span>\n\t\t\t\t\t<span className=\"mt-1 mr-1\">of</span>\t\n\t\t\t\t\t<span className=\"mt-1 mr-1 mark\">{props.data.fixedValue}</span>\n\t\t\t\t</>}\n\n\t\t\t\t{!simpleComparator && props.data.compareTo === \"run\" && <>\n\t\t\t\t\t<span className=\"mt-1 mr-1 mark\">Query Run Date</span>\n\t\t\t\t\t{renderOffset()}\n\t\t\t\t</>}\n\n\t\t\t\t{!simpleComparator && props.data.compareTo.indexOf(\".\") > -1 && <>\n\t\t\t\t\t<span className=\"d-inline-block\">\n\t\t\t\t\t\t<span className=\"mt-1 mr-1 mark\">{compareToLabel}</span>\n\t\t\t\t\t</span>\n\t\t\t\t\t{renderOffset()}\n\t\t\t\t</>}\n\t\t\t</div>\n\t\t</div>\n\t}\n\n\tconst renderEdit = () => <>\n\t\t{ renderHeader() }\n\t\t{ renderComparator() }\n\t\t{ !simpleComparator && renderCompareTarget() }\n\t\t{ !simpleComparator && props.data.compareTo !== \"fixed\" && renderCompareOffset() }\n\t</>\n\n\treturn props.edit ? renderEdit() : renderDisplay();\n\t\n}\n\n//return invalid params\nfunction validateDateProperties(data) {\n\tconst fixedValue = data.comparator.indexOf(\"populated\") === -1 &&\n\t\tdata.compareTo === \"fixed\" &&\n\t\t!/^\\d{4}-\\d{2}-\\d{2}$/.test(data.fixedValue)\n\treturn fixedValue && {fixedValue}\n\t\n}\n\nfunction defaultDateProperties() {\n\treturn {\n\t\tcomparator: \"gte\", compareTo: \"fixed\", \n\t\tfixedValue: \"2020-01-01\", offsetUnit: \"years\",\n\t\toffsetDir: \"plus\", offsetValue: 0, invalid: false\n\t}\n}\n\nexport default DateRule;\nexport {defaultDateProperties};","import React from \"react\";\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome'\nimport { faEdit, faTrashAlt, faCheck } from '@fortawesome/free-solid-svg-icons'\n\n\nfunction CodingRule(props) {\n\n\tfunction validateCodingProperties(newData) {\n\t\tconst code = (!props.fieldDefinition.options || newData.option === \"__custom\") &&\n\t\t\t(newData.code || \"\").replace(/[\\s,]/g).length === 0\n\t\treturn code && {code}\n\t}\n\n\tconst handleChange = (field, value) => {\n\t\tconst newData = {...props.data, [field]: value};\n\t\tconst invalid = validateCodingProperties(newData);\n\t\tprops.onUpdate({...newData, invalid});\n\t}\n\n\tconst renderOptionSelector = () => {\n\t\tconst selection = (\n\t\t\tprops.fieldDefinition.options.find( o => {\n\t\t\t\treturn o.name === props.data.name && o.system === props.data.system && o.code === props.data.code\n\t\t\t})\n\t\t|| {}).name;\n\n\t\tconst buildOptionDisplay = (o) => {\n\t\t\tconst codeCount = (o.code || \"\").split(\",\").length;\n\t\t\tconst codeText = codeCount > 1 ? ` (${codeCount} codes)` : \"\";\n\t\t\treturn o.name + codeText;\n\t\t};\n\n\t\treturn <div>\n\t\t\t<div className=\"my-2\">\n\t\t\t\t<span className=\"mr-1 font-weight-bold\">{props.fieldDefinition.name || props.fieldDefinition.id}</span>\n\t\t\t\t<span>is</span>\n\t\t\t\t{!props.hideControls && <FontAwesomeIcon icon={faTrashAlt} opacity=\"0.5\"\n\t\t\t\t\tonClick={e => props.onDelete(props.id)} \n\t\t\t\t\tstyle={{cursor: \"pointer\"}} \n\t\t\t\t\tpull=\"right\" \n\t\t\t\t/>}\n\t\t\t</div>\n\n\t\t\t<select value={(props.data.option) || \"\"} \n\t\t\t\tonChange={e => handleChange(\"option\", e.target.value)} \n\t\t\t\tclassName={props.data.invalid && props.data.validate ? \"is-invalid form-control\" : \"form-control\"}\n\t\t\t>\n\t\t\t\t{!selection && <option value=\"\"></option>}\n\t\t\t\t{props.fieldDefinition.options.map( o => <option value={o.name} key={o.name}>\n\t\t\t\t\t{buildOptionDisplay(o)}\n\t\t\t\t</option> )}\n\t\t\t\t{props.fieldDefinition.editable && <option value=\"__custom\" key=\"__custom\">Custom</option>}\n\t\t\t</select>\n\t\t</div>\n\t}\n\n\tconst renderCustomEditCode = () => {\n\t\treturn <div>\n\t\t\t<div className=\"my-2\">\n\t\t\t\t<span className=\"mr-1 font-weight-bold\">{props.fieldDefinition.name || props.fieldDefinition.id}</span>\n\t\t\t\t<span>matches the code</span>\n\t\t\t\t{!props.hideControls && <FontAwesomeIcon icon={faTrashAlt} opacity=\"0.5\"\n\t\t\t\t\tonClick={e => props.onDelete(props.id)} \n\t\t\t\t\tstyle={{cursor: \"pointer\"}} \n\t\t\t\t\tpull=\"right\" \n\t\t\t\t/>}\n\t\t\t</div>\t\n\t\t\t<div className=\"form-group\">\n\t\t\t\t<input className=\"form-control\" value={props.data.code || \"\"}\n\t\t\t\t\tonChange={e => handleChange(\"code\", e.target.value)}\n\t\t\t\t\tclassName={props.data.invalid && props.data.validate ? \"is-invalid form-control\" : \"form-control\"}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t}\n\n\tconst renderCustomEdit = () => {\n\n\t\tif (props.fieldDefinition.type === \"code\")\n\t\t\treturn renderCustomEditCode();\n\n\t\treturn <div>\n\t\t\t{ renderHeader() }\n\t\t\t<div className=\"form-group\">\n\t\t\t\t<label>Name (optional)</label>\n\t\t\t\t<input className=\"form-control\" value={props.data.name || \"\"}\n\t\t\t\t\tonChange={e => handleChange(\"name\", e.target.value)}\n\t\t\t\t/>\n\t\t\t</div><div className=\"form-group\">\n\t\t\t\t<label>System (optional)</label>\n\t\t\t\t<input className=\"form-control\" value={props.data.system || \"\"}\n\t\t\t\t\tplaceholder=\"http://loinc.org\"\n\t\t\t\t\tonChange={e => handleChange(\"system\", e.target.value)}\n\t\t\t\t/>\n\t\t\t</div><div className=\"form-group\">\n\t\t\t\t<label>Codes (comma separated)</label>\n\t\t\t\t<textarea value={props.data.code || \"\"}\n\t\t\t\t\tonChange={e => handleChange(\"code\", e.target.value)}\n\t\t\t\t\tclassName={props.data.invalid && props.data.validate ? \"is-invalid form-control\" : \"form-control\"}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t}\n\n\tconst renderHeader = () => <div className=\"my-2\">\n\t\t<span className=\"mr-1 font-weight-bold\">{props.fieldDefinition.name || props.fieldDefinition.id}</span>\n\t\t<span>matches at least one code in</span>\n\t\t{!props.hideControls && <FontAwesomeIcon icon={faTrashAlt} opacity=\"0.5\"\n\t\t\tonClick={e => props.onDelete(props.id)} \n\t\t\tstyle={{cursor: \"pointer\"}} \n\t\t\tpull=\"right\" \n\t\t/>}\n\t</div>\n\n\tconst renderEdit = () => {\n\t\tconst isCustom = props.data.option === \"__custom\" || !props.fieldDefinition.options;\n\t\treturn isCustom ? renderCustomEdit() : renderOptionSelector();\n\t}\n\n\tconst renderDisplay = () => {\n\t\tconst codeCount = props.data.code ? props.data.code.split(\",\").length : 0;\n\t\tconst name = (props.data.option && props.data.option !== \"__custom\" && props.data.option.replace(/^[ -]*/, \"\")) ||\n\t\t\tprops.data.name || \n\t\t\t(codeCount === 1 && props.data.code) ||\n\t\t\t\"Unnamed\";\n\n\t\treturn \t<div>\n\t\t\t{!props.hideControls && \n\t\t\t\t<FontAwesomeIcon icon={faEdit} opacity=\"0.5\"\n\t\t\t\t\t style={{cursor: \"pointer\"}} pull=\"right\" className=\"m-1\" \n\t\t\t\t/>\n\t\t\t}\n\t\t\t<div style={{lineHeight: 2}}>\n\t\t\t\t<span className=\"mt-1 mr-1 font-weight-bold\">{props.fieldDefinition.name || props.fieldDefinition.id}</span>\n\t\t\t\t{codeCount > 1 ? \" matches at least one code in valueset \" : \" matches code \"}\n\t\t\t\t<span className=\"mark mt-1\">{name}</span>\n\t\t\t\t{codeCount > 1 && <span className=\"mt-1\">({codeCount} codes)</span>}\n\t\t\t</div>\n\t\t</div>\n\t\t\n\t\n\t}\n\treturn props.edit ? renderEdit() : renderDisplay();\n\t\n}\n\nfunction defaultCodingProperties() {\n\treturn {invalid: {code: true}}\n}\n\nexport default CodingRule;\nexport { defaultCodingProperties };","import React from \"react\";\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome'\nimport { faEdit, faTrashAlt } from '@fortawesome/free-solid-svg-icons'\n\n\nfunction IdRule(props) {\n\n\tconst handleChange = (field, value) => {\n\t\tconst newData = {...props.data, [field]: value};\n\t\tprops.onUpdate({...newData, invalid: false});\n\t}\n\n\tconst renderEdit = () => {\n\t\treturn <div>\n\t\t\t<div className=\"my-2\">\n\t\t\t\t<span className=\"mr-1 font-weight-bold\">{props.fieldDefinition.name || props.fieldDefinition.id}</span>\n\t\t\t\t<span>is equal to</span>\n\t\t\t\t{!props.hideControls && <FontAwesomeIcon icon={faTrashAlt} opacity=\"0.5\"\n\t\t\t\t\tonClick={e => props.onDelete(props.id)} \n\t\t\t\t\tstyle={{cursor: \"pointer\"}} \n\t\t\t\t\tpull=\"right\" \n\t\t\t\t/>}\n\t\t\t</div>\n\t\t\t<select value={props.data.target} \n\t\t\t\tclassName={props.data.validate && !props.data.target ? \"is-invalid form-control\" : \"form-control\"}\n\t\t\t\tonChange={e => handleChange(\"target\", e.target.value)}\n\t\t\t>\n\t\t\t\t{ !props.data.target && <option key=\"\" value=\"\"></option>}\n\t\t\t\t{(props.relativeOptions || []).sort().map( r => {\n\t\t\t\t\treturn <option key={r.value} value={r.value}>{r.label}</option>\n\t\t\t\t})}\n\t\t\t</select>\n\t\t</div>\n\t}\n\n\tconst renderDisplay = () => {\n\t\tconst targetLabel = props.data.target \n\t\t\t? props.relativeOptions.find( r => r.value === props.data.target ).label\n\t\t\t: \"\";\n\t\treturn <div>\n\t\t\t{!props.hideControls && \n\t\t\t\t<FontAwesomeIcon icon={faEdit} opacity=\"0.5\" style={{cursor: \"pointer\"}} pull=\"right\" className=\"m-1\" />\n\t\t\t}\n\t\t\t<div style={{lineHeight: 2, paddingLeft: \"24px\", textIndent: \"-24px\"}}>\n\t\t\t\t<span className=\"mr-1 font-weight-bold\">{props.fieldDefinition.name || props.fieldDefinition.id}</span>\n\t\t\t\t<span className=\"mr-1\">is equal to</span>\n\t\t\t\t<span className=\"mr-1 mark\">{targetLabel}</span>\n\t\t\t</div>\n\t\t</div>\n\t}\n\n\treturn props.edit ? renderEdit() : renderDisplay();\n\t\n}\n\nexport default IdRule;\n","import React from 'react';\nimport { Col }  from \"react-bootstrap\";\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome'\nimport { faEdit, faTrashAlt } from '@fortawesome/free-solid-svg-icons'\n\nfunction QuantityRule(props) {\n\n\tconst options = {\n\t\tcomparator: [\n\t\t\t{value: \"populated\", display: \"Populated\"},\n\t\t\t{value: \"not_populated\", display: \"Not Populated\"},\n\t\t\t{value: \"eq\", display: \"Equal To\"},\n\t\t\t{value: \"lt\", display: \"Less then\"},\n\t\t\t{value: \"lte\", display: \"Less than or equal to\"},\n\t\t\t{value: \"gt\", display: \"Greater than\"},\n\t\t\t{value: \"gte\", display: \"Greater than or equal to\"}\n\t\t],\n\t\tcompareTarget: [\n\t\t\t{value: \"fixed\", display: \"Fixed Value of\"}\n\t\t],\n\t\toffsetDir: [\n\t\t\t{value: \"plus\", display: \"+\"},\n\t\t\t{value: \"minus\", display: \"-\"}\n\t\t]\n\t}\n\n\t//return invalid params\n\tfunction validateQuantityProperties(data) {\n\t\tconst fixedValue = data.comparator.indexOf(\"populated\") === -1 &&\n\t\t\tdata.compareTo === \"fixed\" &&\n\t\t\t!/^\\d+\\.?\\d+$/.test(data.fixedValue);\n\t\tconst unitCode = data.unitCode && data.unitCode.trim().indexOf(\" \") > -1;\n\t\tconst unitSystem = data.unitSystem && data.unitSystem.trim().indexOf(\" \") > -1\n\t\treturn (fixedValue || unitCode || unitSystem) && \n\t\t\t{fixedValue, unitCode, unitSystem};\n\t}\n\n\tconst handleChange = (field, value) => {\n\t\tconst newData = {...props.data, [field]: value};\n\t\tconst invalid = validateQuantityProperties(newData);\n\t\tprops.onUpdate({...newData, invalid});\n\t}\n\n\tconst mapOptions = (property) => {\n\t\treturn options[property].map( o => {\n\t\t\treturn <option value={o.value} key={o.value}>{o.display}</option>\n\t\t});\n\t};\n\n\tconst renderHeader = () => <div className=\"my-2\">\n\t\t<span className=\"mr-1 font-weight-bold\">{props.fieldDefinition.name || props.fieldDefinition.id}</span>\n\t\t<span>is</span>\n\t\t{!props.hideControls && <FontAwesomeIcon \n\t\t\ticon={faTrashAlt} opacity=\"0.5\"\n\t\t\tonClick={e => props.onDelete(props.id)} \n\t\t\tstyle={{cursor: \"pointer\"}} \n\t\t\tpull=\"right\" \n\t\t/>}\n\t</div>\n\n\tconst renderComparator = () => <div className=\"my-2\">\n\t\t<select className=\"form-control\"\n\t\t\tvalue={props.data.comparator || \"gt\"} \n\t\t\tonChange={e => handleChange(\"comparator\", e.target.value)}\n\t\t>{mapOptions(\"comparator\")}</select>\n\t</div>\n\n\tconst renderCompareTarget = () => {\n\t\tconst invalidValue = props.data.validate && props.data.invalid && props.data.invalid.fixedValue;\n\t\tconst invalidUnitSystem = props.data.validate && props.data.invalid && props.data.invalid.unitSystem;\n\t\tconst invalidUnitCode = props.data.validate && props.data.invalid && props.data.invalid.unitCode;\n\n\t\treturn <>\n\t\t\t\t<div className=\"my-2 form-row\">\n\t\t\t\t<Col>\n\t\t\t\t\t<select className=\"form-control\"\n\t\t\t\t\t\tvalue={props.data.compareTo || \"fixed\"} \n\t\t\t\t\t\tonChange={e => handleChange(\"compareTo\", e.target.value)}\n\t\t\t\t\t>{mapOptions(\"compareTarget\")}\n\t\t\t\t\t\t{(props.relativeOptions || []).sort().map( r => {\n\t\t\t\t\t\t\treturn <option key={r.value} value={r.value}>{r.label}</option>\n\t\t\t\t\t\t})}\n\t\t\t\t\t</select>\n\t\t\t\t</Col>\n\t\t\t\t{(!props.data.compareTo || props.data.compareTo === \"fixed\") && <Col>\n\t\t\t\t\t<input type=\"number\" className=\"form-control\"\n\t\t\t\t\t\trequired={true} \n\t\t\t\t\t\tvalue={props.data.fixedValue || \"\"} \n\t\t\t\t\t\tonChange={e => handleChange(\"fixedValue\", e.target.value)}\n\t\t\t\t\t\tclassName={invalidValue ? \"is-invalid form-control\" : \"form-control\"}\n\t\t\t\t\t/>\n\t\t\t\t</Col>}\n\t\t\t</div>\n\t\t\t{(props.data.compareTo === \"fixed\") && <div className=\"form-row my-2\">\n\t\t\t\t<Col xs=\"4\">\n\t\t\t\t\t<input className=\"form-control\"\n\t\t\t\t\t\trequired={false} \n\t\t\t\t\t\tvalue={props.data.unitCode || \"\"} \n\t\t\t\t\t\tplaceholder=\"Unit Code\"\n\t\t\t\t\t\tonChange={e => handleChange(\"unitCode\", e.target.value)}\n\t\t\t\t\t\tclassName={invalidUnitCode ? \"is-invalid form-control\" : \"form-control\"}\n\t\t\t\t\t/>\n\t\t\t\t</Col><Col>\n\t\t\t\t\t<input className=\"form-control\"\n\t\t\t\t\t\trequired={false} \n\t\t\t\t\t\tvalue={props.data.unitSystem || \"\"} \n\t\t\t\t\t\tplaceholder=\"Unit System\"\n\t\t\t\t\t\tonChange={e => handleChange(\"unitSystem\", e.target.value)}\n\t\t\t\t\t\tclassName={invalidUnitSystem ? \"is-invalid form-control\" : \"form-control\"}\n\t\t\t\t\t/>\n\t\t\t</Col>\n\t\t\t</div>}\n\t\t</>\n\t}\n\n\tconst renderCompareOffset = () => <div className=\"my-2 form-row\"><Col>\n\t\t<select className=\"form-control\"\n\t\t\tvalue={props.data.offsetDir || \"plus\"} \n\t\t\tonChange={e => handleChange(\"offsetDir\", e.target.value)}\n\t\t>{mapOptions(\"offsetDir\")}</select>\n\t</Col><Col>\n\t\t<input type=\"number\" className=\"form-control\"\n\t\t\tvalue={props.data.offsetValue || \"\"}  required={true}\n\t\t\tonChange={e => handleChange(\"offsetValue\", e.target.value)}\n\t\t/>\n\t</Col></div>\n\n\tconst simpleComparator = props.data.comparator &&\n\t\tprops.data.comparator.indexOf(\"populated\") !== -1;\n\n\tconst renderDisplay = () => {\n\n\t\tconst renderOffset = () => {\n\t\t\tif (!props.data.offsetValue) return;\n\t\t\treturn <span className=\"mr-1 mt-1 mark\">\n\t\t\t\t{findOption(\"offsetDir\", props.data.offsetDir)}\n\t\t\t\t{\" \"}{props.data.offsetValue}\n\t\t\t</span>\n\t\t};\n\n\t\tconst findOption = (property, value) => {\n\t\t\treturn options[property].find( o => o.value === value).display;\n\t\t}\n\n\t\tconst compareToLabel = !simpleComparator && props.data.compareTo.indexOf(\".\") > -1 &&\n\t\t\tprops.relativeOptions.find( r => r.value === props.data.compareTo ).label;\n\n\n\t\treturn <div>\n\t\t\t{!props.hideControls && \n\t\t\t\t<FontAwesomeIcon icon={faEdit} opacity=\"0.5\" style={{cursor: \"pointer\"}} pull=\"right\" className=\"m-1\" />\n\t\t\t}\n\t\t\t\n\t\t\t<div style={{lineHeight: 2}}>\n\t\t\t\t<span className=\"mt-1 mr-1 font-weight-bold\">{props.fieldDefinition.name || props.fieldDefinition.id}</span>\n\t\t\t\t<span className=\"mt-1 mr-1\">is</span>\n\t\t\t\t<span className=\"mt-1 mr-1 mark\">\n\t\t\t\t\t{findOption(\"comparator\", props.data.comparator).toLowerCase()}\n\t\t\t\t</span>\n\n\t\t\t\t{!simpleComparator && props.data.compareTo === \"fixed\" && <>\n\t\t\t\t\t<span className=\"mt-1 mr-1 mark\">{props.data.fixedValue}</span>\n\t\t\t\t\t{props.data.unitCode && <span className=\"mt-1 mr-1 mark\">{props.data.unitCode}</span>}\n\t\t\t\t</>}\n\n\t\t\t\t{!simpleComparator && props.data.compareTo.indexOf(\".\") > -1 && <>\n\t\t\t\t\t<span className=\"d-inline-block\">\n\t\t\t\t\t\t<span className=\"mt-1 mr-1 mark\">{compareToLabel}</span>\n\t\t\t\t\t</span>\n\t\t\t\t\t{renderOffset()}\n\t\t\t\t</>}\n\t\t\t</div>\n\t\t</div>\n\t}\n\n\tconst renderEdit = () => <>\n\t\t{ renderHeader() }\n\t\t{ renderComparator() }\n\t\t{ !simpleComparator && renderCompareTarget() }\n\t\t{ !simpleComparator && props.data.compareTo !== \"fixed\" && renderCompareOffset() }\n\t</>\n\n\treturn props.edit ? renderEdit() : renderDisplay();\n\t\n}\n\nfunction defaultQuantityProperties() {\n\treturn {\n\t\tcomparator: \"gte\", compareTo: \"fixed\",\n\t\tfixedValue: \"\",\n\t\toffsetDir: \"plus\", offsetValue: 0, \n\t\tinvalid: false\n\t}\n}\n\nexport default QuantityRule;\nexport {defaultQuantityProperties};","import React, {useState} from \"react\";\nimport DateRule, {defaultDateProperties} from \"./DateRule\";\nimport CodingRule, { defaultCodingProperties } from \"./CodingRule\";\nimport {Button, ListGroup, ListGroupItem }  from \"react-bootstrap\";\nimport IdRule from \"./IdRule\";\nimport QuantityRule, { defaultQuantityProperties } from \"./QuantityRule\";\n\nfunction Restrictions(props) {\n\n\tconst [edit, setEdit] = useState(props.edit);\n\n\tconst handleUpdateRule = (pos, ruleData) => {\n\t\tprops.onUpdate(\n\t\t\tprops.data.map( (r, i) => pos === i ? ruleData : r )\n\t\t)\n\t}\n\n\tconst handleDeleteRule = pos => {\n\t\tif (props.data.length === 1)\n\t\t\treturn props.onDelete(props.id);\n\n\t\tprops.onUpdate(\n\t\t\tprops.data.filter( (r, i) => pos !== i )\n\t\t)\n\t}\n\n\tconst handleOr = () => {\n\t\tprops.onUpdate(\n\t\t\tprops.data.concat([getRuleDefaults(props.fieldDefinition)])\n\t\t);\n\t}\n\n\tconst handleDone = () => {\n\t\tconst invalid = props.data.filter( r => r.invalid ? true : false )\n\t\tif (invalid.length)\n\t\t\treturn props.onUpdate(\n\t\t\t\tprops.data.map( r => ({...r, validate: true}) )\n\t\t\t);\n\n\t\tsetEdit(false);\n\t}\n\t\t\n\tconst renderRule = (ruleData, i) => {\n\t\tif (props.fieldDefinition.type === \"date\") {\n\t\t\tconst relativeOptions = (props.relativeOptions||[]).filter( r => r.fieldType === \"date\" );\n\t\t\treturn <DateRule \n\t\t\t\tdata={ruleData} \n\t\t\t\tfieldDefinition={props.fieldDefinition} \n\t\t\t\trelativeOptions={relativeOptions}\n\t\t\t\tedit={edit}\n\t\t\t\tonUpdate={data => handleUpdateRule(i, data)}\n\t\t\t\tonDelete={e => handleDeleteRule(i)}\n\t\t\t\thideControls={!edit && i > 0}\n\t\t\t/>\n\t\t} else if (props.fieldDefinition.type === \"coding\" || props.fieldDefinition.type === \"code\") {\n\t\t\treturn <CodingRule \n\t\t\t\tdata={ruleData} \n\t\t\t\tfieldDefinition={props.fieldDefinition} \n\t\t\t\tisCode = {props.fieldDefinition.type === \"code\"}\n\t\t\t\tedit={edit}\n\t\t\t\tonUpdate={data => handleUpdateRule(i, data)}\n\t\t\t\tonDelete={e => handleDeleteRule(i)}\n\t\t\t\thideControls={!edit && i > 0}\n\t\t\t/>\n\t\t} else if (props.fieldDefinition.type === \"fhirId\") {\n\t\t\tconst relativeOptions = (props.relativeOptions||[]).filter( r => r.fieldType === \"fhirId\" );\n\t\t\treturn <IdRule \n\t\t\t\tdata={ruleData} \n\t\t\t\trelativeOptions={relativeOptions}\n\t\t\t\tfieldDefinition={props.fieldDefinition} \n\t\t\t\tedit={edit}\n\t\t\t\tonUpdate={data => handleUpdateRule(i, data)}\n\t\t\t\tonDelete={e => handleDeleteRule(i)}\n\t\t\t\thideControls={!edit && i > 0}\n\t\t\t/>\n\t\t} else if (props.fieldDefinition.type === \"quantity\") {\n\t\t\tconst relativeOptions = (props.relativeOptions||[]).filter( r => r.fieldType === \"quantity\" );\n\t\t\treturn <QuantityRule \n\t\t\t\tdata={ruleData} \n\t\t\t\trelativeOptions={relativeOptions}\n\t\t\t\tfieldDefinition={props.fieldDefinition} \n\t\t\t\tedit={edit}\n\t\t\t\tonUpdate={data => handleUpdateRule(i, data)}\n\t\t\t\tonDelete={e => handleDeleteRule(i)}\n\t\t\t\thideControls={!edit && i > 0}\n\t\t\t/>\n\t\t}\n\t}\n\n\treturn <ListGroup className=\"shadow my-4\">\n\t\t{edit && <ListGroupItem className=\"text-right\">\n\t\t\t<Button variant=\"outline-primary\" size=\"sm\"\n\t\t\t\tonClick={handleDone} \n\t\t\t>Done</Button>\n\t\t</ListGroupItem>}\n\n\t\t{props.data.map( (rule, i) => {\n\t\t\treturn <ListGroupItem key={i}  onClick={e => !edit && setEdit(true)}>\n\t\t\t\t{i > 0 && <div className=\"text-center p-1 mb-1\">\n\t\t\t\t\t<span className=\"badge badge-pill badge-primary\">or</span>\n\t\t\t\t</div>}\n\t\t\t\t{ renderRule(rule, i) }\n\t\t\t</ListGroupItem>\n\t\t})}\n\n\t\t{edit && <ListGroupItem className=\"text-center\">\n\t\t\t<Button variant=\"outline-primary\" size=\"sm\"\n\t\t\t\tonClick={handleOr}\n\t\t\t>Or...</Button>\n\t\t</ListGroupItem>}\n\t</ListGroup>\n\n}\n\n\nfunction getRuleDefaults(fieldDefinition, ruleData={}) {\n\tif (fieldDefinition.type === \"date\") {\n\t\treturn  {invalid: false, ...defaultDateProperties(), ...(fieldDefinition.defaults || {}), ...ruleData};\n\t} else if (fieldDefinition.type === \"quantity\") {\n\t\treturn  {invalid: false, ...defaultQuantityProperties(), ...(fieldDefinition.defaults || {}), ...ruleData};\n\t} else if (fieldDefinition.type === \"coding\" || fieldDefinition.type === \"code\") {\n\t\treturn  {invalid: true, ...defaultCodingProperties(), ...(fieldDefinition.defaults || {}), ...ruleData};\n\t} else {\n\t\treturn  {invalid: true, ...(fieldDefinition.defaults || {}), ...ruleData};\n\t}\n}\n\n\nexport default Restrictions;\nexport {getRuleDefaults} ;","import React from \"react\";\nimport _ from \"lodash\";\n\nfunction Retention(props) {\n\n\tconst retentionValue = props.retentionType !== \"none\" && \n\t\tprops.retentionType !== \"all\" && props.retentionSortField\n\t\t\t? props.retentionType + \".\" + props.retentionSortField \n\t\t\t: props.retentionType || \"none\";\n\n\tconst retentionOptions = [\n\t\t{name: `Don't retain matching ${props.definition.name} values` , value: \"none\"},\n\t\t{name: `Retain all matching ${props.definition.name} values`, value: \"all\"}\n\t].concat(\n\t\t_.chain(props.definition.fields)\n\t\t\t.filter( f => f.type === \"date\" )\n\t\t\t.sortBy( \"name\" )\n\t\t\t.map( f => [\n\t\t\t\t{name: \"Retain most recent match based on \" + (f.name || f.id) , value: \"latest.\"+f.id},\n\t\t\t\t{name: \"Retain earliest match based on \" + (f.name || f.id) , value: \"earliest.\"+f.id}\n\t\t\t]).flatten().value()\n\t);\n\n\tconst handleVarChange = e => {\n\t\tif (/^[a-zA-Z_]?[a-zA-Z0-9_]*$/.test(e.target.value)) {\n\t\t\tconst invalid = !e.target.value || \n\t\t\t\t(props.usedVars||[]).find( v => v === e.target.value );\n\t\t\tprops.onChange({retentionVar: e.target.value, invalid});\n\t\t}\n\t}\n\n\tconst handleValueChange = e => {\n\t\tconst [retentionType, retentionSortField] = e.target.value.split(\".\");\n\t\tconst invalid = retentionType !== \"none\" && (!props.retentionVar || props.invalid);\n\t\tprops.onChange({retentionType, retentionSortField, invalid});\n\t}\n\n\tconst renderEdit = () => {\n\t\tconst errors = props.validate && props.invalid;\n\t\tconst retentionVar = props.retentionVar || \"\";\n\t\n\t\treturn <div className=\"container-fluid\">\n\t\t\t<div className=\"row my-1\"><div className=\"col\">\n\t\t\t\t<select className=\"form-control\"\n\t\t\t\t\tvalue={retentionValue} \n\t\t\t\t\tonChange={handleValueChange}\n\t\t\t\t>{\n\t\t\t\t\tretentionOptions.map( r => {\n\t\t\t\t\t\treturn <option key={r.value} value={r.value}>{r.name}</option>\n\t\t\t\t\t})\n\t\t\t\t}</select>\n\t\t\t</div></div>\n\t\n\t\t\t{retentionValue !== \"none\" && <div className=\"form-row my-2\">\n\t\t\t\t<div className=\"col col-auto align-self-center\">as</div>\n\t\t\t\t<div className=\"col\">\n\t\t\t\t\t<input value={retentionVar} \n\t\t\t\t\t\tplaceholder=\"Name\"\n\t\t\t\t\t\tonChange={handleVarChange} \n\t\t\t\t\t\tclassName={errors ? \"is-invalid form-control\" : \"form-control\"}\n\t\t\t\t\t/>\n\t\t\t\t\t{ errors &&\n\t\t\t\t\t\t<div className=\"small text-danger mt-1\">Note: variable name can't be blank and must be unique</div>\n\t\t\t\t\t}\n\t\t\t\t</div>\n\t\t\t</div>}\n\t\n\t\t</div>\n\t}\n\n\treturn renderEdit() ;\n\n\n}\n\nexport default Retention;","import React, {useState} from \"react\";\nimport Restrictions, {getRuleDefaults} from \"./Restrictions\";\nimport Retention from \"./Retention\";\nimport _ from \"lodash\";\nimport { Modal, Button, DropdownButton, Dropdown, ListGroup, ListGroupItem, Form }  from \"react-bootstrap\";\n\nfunction BlockEditor(props) {\n\n\tconst [name, setName] = useState(props.data.name);\n\tconst [retention, setRetention] = useState(props.data.retention || {retentionType: \"none\"});\n\tconst [rules, setRules] = useState(props.data.rules || []);\n\tconst [nextRuleId, setNextRuleId] = useState(props.data.nextRuleId || 0);\n\n\tconst [isDirty, setIsDirty] = useState();\n\tconst [dirtyWarning, setDirtyWarning] = useState();\n\tconst [referenceWarning, setReferenceWarning] = useState();\n\n\tconst [definition, setDefinition] = useState(props.data.definition);\n\tconst [validate, setValidate] = useState();\n\t\n\tconst updateRule = (ruleId, newRule) => {\n\t\tsetRules(\n\t\t\trules.map(rule => rule.id !== ruleId ? rule : {...rule, restrictions: newRule})\n\t\t);\n\t\tsetIsDirty(true);\n\t}\n\n\tconst addRule = fieldId => {\t\n\t\tconst fieldDefinition = definition.fields.find( d => d.id === fieldId);\n\t\tsetRules(\n\t\t\trules.concat([{id: nextRuleId, fieldId, edit: true, restrictions: [getRuleDefaults(fieldDefinition)] }])\n\t\t);\n\t\tsetNextRuleId(nextRuleId+1);\n\t\tsetIsDirty(true);\n\t}\n\n\tconst deleteRule = ruleId => {\n\t\tsetRules(rules.filter( rule => rule.id !== ruleId ));\n\t\tsetIsDirty(true)\n\t}\n\n\tconst handleSaveBlock = () => {\n\t\tconst invalidRules = rules.filter(r => {\n\t\t\treturn r.restrictions.filter(rs => rs.invalid ? true : false).length\n\t\t});\n\t\tif (invalidRules.length > 0) setRules(\n\t\t\trules.map( r => ({\n\t\t\t\t...r,\n\t\t\t\tedit: r.restrictions.filter(rs => rs.invalid ? true : false).length > 0,\n\t\t\t\trestrictions: r.restrictions.map(rs => ({...rs, validate: true}) )\n\t\t\t}) )\n\t\t);\n\t\tif (retention.invalid || !name) setValidate(true);\n\t\tif (invalidRules.length > 0 || retention.invalid || !name)\n\t\t\treturn;\n\t\t\n\t\tprops.onSave({\n\t\t\tname, retention, definition, \n\t\t\tparentId: props.parentId, id: props.id,\n\t\t\tnextRuleId,\n\t\t\trules: rules.map( r => {\n\t\t\t\tconst restrictions = r.restrictions.map( restriction => {\n\t\t\t\t\tconst {validate, invalid, ...detail} = restriction;\n\t\t\t\t\treturn detail;\n\t\t\t\t})\n\t\t\t\tconst {edit, ...rule} = r;\n\t\t\t\treturn {...rule, restrictions}\n\t\t\t})\n\t\t})\n\t\n\t}\n\n\tconst handleClose = (e, force) => {\n\t\te && e.preventDefault();\n\t\tif (isDirty && !force && definition) {\n\t\t\tsetDirtyWarning(true);\n\t\t} else {\n\t\t\tprops.onClose();\n\t\t}\n\t}\n\n\tconst handleDeleteBlock = (e, force) => {\n\t\tif (!force && props.isReferenced) {\n\t\t\tsetReferenceWarning(true);\n\t\t} else {\n\t\t\tprops.onDelete();\n\t\t}\n\t}\n\n\tconst renderRenderBlockTypeList = () => {\n\t\tconst renderBlockType = (block, i) => {\n\t\t\treturn <ListGroupItem key={i} action onClick={ e => {\n\t\t\t\tsetName(block.name); \n\t\t\t\tsetDefinition(block);\n\t\t\t }}>\n\t\t\t\t{block.name}\n\t\t\t</ListGroupItem>\n\t\t}\n\t\treturn <>\n\t\t\t<Modal.Header closeButton>\n\t\t\t\t<Modal.Title>Block Type</Modal.Title>\n\t\t\t</Modal.Header>\n\t\t\t<Modal.Body><ListGroup>\n\t\t\t\t{props.definitions.map(renderBlockType)}\n\t\t\t</ListGroup></Modal.Body>\n\t\t</>\n\t}\n\n\tconst renderHeader = () => {\n\t\tconst idJoinOptions = props.relativeOptions.find( r => r.fieldType === \"fhirId\");\n\t\tconst ddFields = definition.fields\n\t\t\t.filter( f => f.name !== \"patient\" && (idJoinOptions || f.type !== \"fhirId\"));\n\n\t\treturn <div className=\"d-flex\">\n\t\t\t<DropdownButton title=\"Add Rule\" variant=\"success\" className=\"mr-auto\">\n\t\t\t\t{ddFields.map( field => {\n\t\t\t\t\treturn <Dropdown.Item onClick={e => addRule(field.id)} key={field.id}>\n\t\t\t\t\t\t{field.name || field.id}\n\t\t\t\t\t</Dropdown.Item>\n\t\t\t\t})}\n\t\t\t</DropdownButton>\n\t\t\t<Button variant=\"outline-danger\" className=\"mr-2\" onClick={handleDeleteBlock}>Delete Block</Button>\n\t\t\t{ isDirty && <Button variant=\"primary\" className=\"mr-1\" onClick={handleSaveBlock}>Save Block</Button> }\n\t\t</div>\n\t}\n\n\n\tconst renderRules = () => {\n\t\treturn rules.map( rule => {\n\t\t\tconst id = rule.id;\n\t\t\tconst fieldDefinition = definition.fields.find( d => d.id === rule.fieldId)\n\t\t\treturn <div key={rule.id}><Restrictions\n\t\t\t\tfieldDefinition={fieldDefinition}\n\t\t\t\trelativeOptions={props.relativeOptions}\n\t\t\t\tdata={rule.restrictions}\n\t\t\t\tedit={rule.edit}\n\t\t\t\tonUpdate={r => updateRule(id, r)}\n\t\t\t\tonDelete={r => deleteRule(id, r)}\n\t\t\t/></div>\n\t\t})\n\t}\n\n\tconst hasErrors = rules.filter(r => {\n\t\treturn r.restrictions.filter(rs => rs.invalid && rs.validate ? true : false).length > 0\n\t}).length > 0 || (validate && !name) || (validate && retention.invalid);\n\n\tconst renderRuleList = () => <>\n\t\t<Modal.Header closeButton>\n\t\t\t<Modal.Title className=\"d-flex flex-grow-1\">\n\t\t\t\t<Form.Control \n\t\t\t\t\tautoFocus\n\t\t\t\t\tplaceholder=\"Name\"\n\t\t\t\t\tvalue={name || \"\"}\n\t\t\t\t\tclassName={validate && !name ? \"is-invalid\" : \"\"}\n\t\t\t\t\tonChange={e => {\n\t\t\t\t\t\tsetName(e.target.value);\n\t\t\t\t\t\tsetIsDirty(true);\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t\t</Modal.Title>\n\t\t</Modal.Header>\n\t\t<Modal.Body>\n\t\t\t<p>Block Type: {definition.name} <small>({definition.version})</small></p>\n\t\t\t{ dirtyWarning && <div className=\"alert alert-danger text-center mb-4\">\n\t\t\t\tYou have unsaved changes -&nbsp;\n\t\t\t\t<a href=\"#\" className=\"alert-link\" onClick={e => handleClose(e, true)}>discard?</a>\n\t\t\t</div>}\n\t\t\t{ referenceWarning && <div className=\"alert alert-danger text-center mb-4\">\n\t\t\t\tOther blocks reference this block -&nbsp;\n\t\t\t\t<a href=\"#\" className=\"alert-link\" onClick={e => handleDeleteBlock(e, true)}>delete anyway?</a>\n\t\t\t</div>}\n\t\t\t{ hasErrors && <div className=\"alert alert-danger text-center mb-4\">\n\t\t\t\tPlease fix the highlighted errors\n\t\t\t</div>}\n\t\t\t{ renderHeader() }\n\t\t\t{ renderRules() }\n\t\t</Modal.Body>\n\t\t<Modal.Footer>\n\t\t\t<Retention\n\t\t\t\t{...retention}\n\t\t\t\tdefinition={definition}\n\t\t\t\tusedVars={props.usedVars}\n\t\t\t\tvalidate={validate}\n\t\t\t\tonChange={newRetention => {\n\t\t\t\t\tsetRetention({...retention, ...newRetention}); \n\t\t\t\t\tsetIsDirty(true)\n\t\t\t\t}}\n\t\t\t\tedit={true}\n\t\t\t/>\n\t\t</Modal.Footer>\n\t</>\n\n\treturn <Modal backdrop=\"static\" show={true} animation={false} onHide={handleClose} size=\"lg\">\n\t\t{definition ? renderRuleList() : renderRenderBlockTypeList()}\n\t</Modal>\n\n}\n\nexport default BlockEditor;","import React, {useState} from \"react\";\nimport _ from \"lodash\";\nimport { Button, DropdownButton, Dropdown, Badge, Row, Col } from \"react-bootstrap\";\nimport { useStoreon } from \"storeon/react\";\nimport BlockEditor from \"./BlockEditor\";\n\nfunction BlockChart(props) {\n\n\tconst { dispatch, blocks, definitions, patients } = useStoreon(\"blocks\", \"definitions\", \"patients\");\n\tconst [activeInstance, setActiveInstance] = useState();\n\tlet cells = {};\n\n\tconst blockList = blocks.concat(\n\t\tblocks.filter( b => {\n\t\t\treturn !blocks.find( node => node.parentId === b.id )\n\t\t}).map( b => {\n\t\t\treturn {id: b.id+\"-end\", name: b.exclude? \"Exclude\" : \"Include\", parentId: b.id, isLeaf:true, patients: patients}\n\t\t})\n\t)\n\tconst walkUp = (id, span=1) => {\n\t\tconst node = blockList.find( b => b.id === id );\n\t\tif (cells[id]) {\n\t\t\tcells[id].span = cells[id].span + span;\n\t\t} else {\n\t\t\tcells[id] = {\n\t\t\t\tid, span, name: node.name, retention: node.retention, \n\t\t\t\tparentId: node.parentId, isLeaf: node.isLeaf,\n\t\t\t\tpatients: node.patients\n\t\t\t}\n\t\t}\n\t\tif (node && node.parentId !== null) walkUp(node.parentId, span)\n\n\t}\n\n\tconst walkDown = (id, row, col=1) => {\n\t\tcells[id] = {...cells[id], id, row, col,}\n\n\t\tlet nextCol = col;\n\t\tblockList.filter( bi => bi.parentId === id )\n\t\t\t.forEach( child => {\n\t\t\t\twalkDown(child.id, row+1, nextCol)\n\t\t\t\tnextCol = nextCol + cells[child.id].span;\n\t\t\t});\n\t}\n\n\t//walk up from leaf nodes\n\tblockList.filter( bi => {\n\t\treturn !blockList.find( child => child.parentId === bi.id )\n\t}).forEach( node => walkUp(node.id) );\n\n\t//walk down from root node\n\tblockList.filter( bi => bi.parentId === null )\n\t\t.forEach( (node, i) => walkDown(node.id, 1, 1) );\n\n\tconst colCount = blockList.reduce( (acc, node) => {\n\t\tconst cell = cells[node.id];\n\t\treturn Math.max(acc, cell.col + cell.span);\n\t}, 0);\n\n\tconst rowCount = blockList.reduce( (acc, node) => {\n\t\treturn Math.max(acc, cells[node.id].row) \n\t}, 0);\n\n\tconst saveBlock = data => {\n\t\tdispatch(\"block/upsert\", {block: data, insertAbove: (activeInstance && activeInstance.insertAbove) || undefined});\n\t\tsetActiveInstance(null);\n\t}\n\n\tconst deleteBlock = () => {\n\t\tif (activeInstance.id !== undefined)\n\t\t\tdispatch(\"block/delete\", activeInstance);\n\t\tsetActiveInstance(null);\n\t}\n\n\tlet skip = 0;\n\tconst renderCell = (r, c, cell) => {\n\n\t\tconst cellStyles = \"btn m-2 p-4 flex-grow-1 block-button text-dark \" + (\n\t\t\t(cell.name === \"Include\" && \"btn-outline-success\") || \n\t\t\t(cell.name === \"Exclude\" && \"btn-outline-danger\") ||\n\t\t\t\"btn-outline-primary\"\n\t\t);\n\n\t\tconst retentionText = cell.retention && cell.retention.retentionType !== \"none\"\n\t\t\t? `retain ${cell.retention.retentionType} as ${cell.retention.retentionVar}`\n\t\t\t: \"\";\n\n\t\tconst name = retentionText\n\t\t\t? <span>{cell.name}<br/>&#8595;<br/>{retentionText}</span>\n\t\t\t: cell.name;\n\n\t\treturn <td key={r+\":\"+c} colSpan={cell.span} className=\"text-center\" style={{height: \"1px\"}}>\n\t\t\t<div className=\"h-100 w-100 d-flex flex-column\">\n\t\t\t\t{ r !== 1 && !cell.isLeaf && <div>\n\t\t\t\t\t<DropdownButton title=\"&#8595;\" size=\"sm\" variant=\"outline-primary\" className=\"m-2 no-caret\">\n\t\t\t\t\t\t<Dropdown.Item href=\"#\" onClick={e => setActiveInstance({parentId: cell.parentId})}>Add Branch</Dropdown.Item>\n\t\t\t\t\t\t<Dropdown.Item href=\"#\" onClick={e => setActiveInstance({parentId: cell.parentId, insertAbove: cell.id})}>Insert Block</Dropdown.Item>\n\t\t\t\t\t</DropdownButton>\n\t\t\t\t</div> }\n\n\t\t\t\t{ cell.isLeaf && <div>\n\t\t\t\t\t<Button size=\"sm\" variant=\"outline-primary\" className=\"m-2\"\n\t\t\t\t\t\tonClick={e => setActiveInstance({parentId: cell.parentId})}\n\t\t\t\t\t>&#8595;</Button>\n\t\t\t\t</div> }\n\n\t\t\t\t<button className={cellStyles} onClick={e => {\n\t\t\t\t\tif (cell.isLeaf) {\n\t\t\t\t\t\tsaveBlock({\n\t\t\t\t\t\t\tid: cell.parentId, \n\t\t\t\t\t\t\texclude: cell.name === \"Exclude\" ? false : true\n\t\t\t\t\t\t});\n\t\t\t\t\t} else if (cell.id !==\"root\" && !cell.isLeaf) {\n\t\t\t\t\t\tsetActiveInstance({id: cell.id, parentId: cell.parentId})\n\t\t\t\t\t};\n\t\t\t\t}}>\n\t\t\t\t\t{name}\n\t\t\t\t</button>\n\t\t\t\t\n\t\t\t\t{ cell.patients !== undefined && <div>\n\t\t\t\t\t<Badge variant=\"primary\" size=\"sm\">{cell.patients} {cell.patients !== 1 ? \"Patients\" : \"Patient\"}</Badge>\n\t\t\t\t</div> }\n\t\t\t</div>\n\t\t</td>;\n\t}\n\n\tconst renderRow = r => {\n\t\tlet skip = 0;\n\t\treturn <tr key={r} className=\"\" style={{height: \"100%\"}}>{\n\t\t\t _.range(1, colCount).map( c => {\n\t\t\t\t if (skip) {\n\t\t\t\t\tskip -=1;\n\t\t\t\t\treturn;\n\t\t\t\t }\n\t\t\t\tconst cell = _.find(cells, cell => cell.row === r && cell.col === c);\n\t\t\t\tif (cell) {\n\t\t\t\t\tskip = cell.span-1;\n\t\t\t\t\treturn renderCell(r, c, cell) \n\t\t\t\t} else {\n\t\t\t\t\treturn <td key={r+\":\"+c}></td>;\n\t\t\t\t}\n\t\t\t})\n\t\t}</tr>\n\t}\n\t\n\tconst getRelativeOptions = (blockId, blocks) => {\n\t\tlet relativeOptions = [];\n\n\t\tconst block = blocks.find( b => b.id === blockId);\n\n\t\tblock.retention && block.retention.retentionVar && \n\t\t\tblock.definition.fields.forEach( field => {\n\t\t\t\trelativeOptions.push({\n\t\t\t\t\tretentionVar: block.retention.retentionVar,\n\t\t\t\t\tfieldType: field.type,\n\t\t\t\t\tfieldName: field.name || field.id,\n\t\t\t\t\tvalue: [block.id, field.id].join(\".\"),\n\t\t\t\t\tlabel: [block.retention.retentionVar, field.name || field.id].join(\".\")\n\t\t\t\t})\n\t\t\t});\n\t\t\n\t\treturn block.parentId !== null\n\t\t\t? relativeOptions.concat( getRelativeOptions(block.parentId, blocks) )\n\t\t\t: relativeOptions;\n\t}\n\n\n\n\tconst renderModal = () => {\n\t\tconst data = blocks.find( b => b.id === activeInstance.id) || {};\n\t\tconst retentionVar = data.retention && data.retention.retentionType !== \"none\" ? data.retention.retentionVar : \"\";\n\t\tconst usedVars = blocks\n\t\t\t.filter( b => b.retention && b.retention.retentionType !== \"none\" && \n\t\t\t\tb.retention.retentionVar && \n\t\t\t\tb.retention.retentionVar !== retentionVar\n\t\t\t)\n\t\t\t.map( b => b.retention.retentionVar );\n\n\t\tconst relativeOptions = data.parentId !== null ? getRelativeOptions(activeInstance.parentId, blocks) : [];\n\n\t\tconst isReferenced = blocks.find( b => {\n\t\t\treturn b.rules && b.rules.find( r => {\n\t\t\t\treturn r.restrictions && r.restrictions.find( rs => {\n\t\t\t\t\treturn (rs.compareTo && rs.compareTo.split(\".\")[0] === activeInstance.id.toString()) ||\n\t\t\t\t\t\t(rs.target && rs.target.split(\".\")[0] === activeInstance.id.toString())\n\t\t\t\t})\n\t\t\t})\n\t\t});\n\n\t\tconsole.log(isReferenced)\n\n\t\treturn <BlockEditor \n\t\t\tid={activeInstance.id}\n\t\t\tparentId={activeInstance.parentId}\n\t\t\tdata={data}\n\t\t\tdefinitions={definitions}\n\t\t\tusedVars={usedVars}\n\t\t\tonClose={e => setActiveInstance(null)}\n\t\t\trelativeOptions={relativeOptions}\n\t\t\tonSave={saveBlock}\n\t\t\tonDelete={deleteBlock}\n\t\t\tisReferenced={!!isReferenced}\n\t\t/>\n\t}\n\n\treturn <div>\n\t\t<div className=\"container-fluid split\">\n\t\t\t<table className=\"m-4\"><tbody>\n\t\t\t\t{ _.range(1, rowCount+1).map( renderRow )}\n\t\t\t</tbody></table></div>\n\t\t\t{ activeInstance && renderModal() }\n\t</div>\n\t\n\n}\n\nexport default BlockChart;","import React from 'react';\nimport './App.css';\nimport {Navbar, Nav, Dropdown, ButtonGroup, Button, Form} from 'react-bootstrap';\nimport { useStoreon } from \"storeon/react\";\n\nimport QueryRunner from './QueryRunnner';\nimport ExportQuery from './ExportQuery';\nimport BlockChart from \"./BlockChart\";\n\n\n\nfunction App() {\n\n\tconst {view, hasTestConfig, dispatch} = useStoreon(\"view\", \"hasTestConfig\");\n\n\tconst handleShowTest = (mode, e) => {\n\t\te.preventDefault();\n\t\tdispatch(\"view/set\", mode);\n\t}\n\n\n\tconst handleShowExport = e => {\n\t\te.preventDefault();\n\t\tdispatch(\"view/set\", \"export\");\n\t}\n\n\tconst renderTestButton = () => {\n\t\treturn hasTestConfig\n\t\t\t? <Form inline>\n\t\t\t\t<Dropdown as={ButtonGroup}>\n\t\t\t\t<Button variant=\"outline-light\" onClick={handleShowTest.bind(this, \"test-run\")}>Test Query</Button>\n\t\t\t\t<Dropdown.Toggle split variant=\"outline-light\" />\n\t\t\t\t<Dropdown.Menu>\n\t\t\t\t\t<Dropdown.Item onClick={handleShowTest.bind(this, \"test-configure\")}>Change Data Source</Dropdown.Item>\n\t\t\t\t</Dropdown.Menu>\n\t\t\t\t</Dropdown>\n\t\t\t\t</Form>\n\t\t\t: <Button variant=\"outline-light\" onClick={handleShowTest.bind(this, \"test-configure\")}>Test Query</Button>;\n\n\t}\n\n\treturn <div>\n\t\t<Navbar bg=\"info\" variant=\"dark\">\n\t\t\t<Navbar.Brand href=\"#\">FHIR Cohort Query Builder</Navbar.Brand>\n\t\t\t<Nav className=\"ml-auto\">\n\t\t\t\t{ renderTestButton() }\n\t\t\t\t<Button variant=\"outline-light\" className=\"ml-3\" onClick={handleShowExport}>Export SQL</Button>\n\t\t\t</Nav>\n\t\t</Navbar>\n\t\t{view === \"export\" && <ExportQuery />}\n\t\t<QueryRunner show={view && view.indexOf(\"test\") === 0} mode={view} />\n\t\t<BlockChart />\n\t</div>\n\n}\n\nexport default App;\n\n","export default [{\n\t\"name\": \"Lab Result - Numerical\",\n\t\"version\": \"1.0.0.alpha\",\n\t\"tableName\": \"Observation\",\n\t\"patientIdField\": \"subject.reference_id_aa\",\n\t\"fields\": [\n\t\t{\"id\": \"status\", \"type\": \"code\", \"field\": \"status\", \"editable\": true,\n\t\t\t\"options\": [\n\t\t\t\t{\"values\": [{\"code\": \"registered\"}], \"name\": \"Registered\"},\n\t\t\t\t{\"values\": [{\"code\": \"preliminary\"}], \"name\": \"Preliminary\"},\n\t\t\t\t{\"values\": [{\"code\": \"final\"}], \"name\": \"Final\"},\n\t\t\t\t{\"values\": [{\"code\": \"amended\"}], \"name\": \"Amended\"},\n\t\t\t\t{\"values\": [{\"code\": \"corrected\"}], \"name\": \"- Corrected\"},\n\t\t\t\t{\"values\": [{\"code\": \"cancelled\"}], \"name\": \"Cancelled\"},\n\t\t\t\t{\"values\": [{\"code\": \"entered-in-error\"}], \"name\": \"Entered in Error\"},\n\t\t\t\t{\"values\": [{\"code\": \"unknown\"}], \"name\": \"Unknown\"}\n\t\t\t]\n\t\t},\n\t\t{\"id\": \"id\", \"type\": \"fhirId\", \"field\": \"id\"},\n\t\t{\"id\": \"effectiveDateTimeStart\", \"type\": \"date\", \"field\": \"effectiveDateTime_aa.start\"},\n\t\t{\"id\": \"effectiveDateTimeEnd\", \"type\": \"date\", \"field\": \"effectiveDateTime_aa.end\"},\n\t\t{\"id\": \"valueQuantity\", \"type\": \"quantity\", \"field\": \"valueQuantity\"},\n\t\t{\"id\": \"code\", \"type\": \"coding\", \"field\": \"code.coding[]\"},\n\t\t{\"id\": \"dataAbsentReason\", \"type\": \"coding\", \"field\": \"dataAbsentReason.coding\", \"editable\": true,\n\t\t\t\"options\": [\n\t\t\t\t{\"values\": [{\"code\": \"unknown\"}], \"name\": \"Unknown\"},\n\t\t\t\t{\"values\": [{\"code\": \"asked-unknown\"}], \"name\": \"-  Asked But Unknown\"},\n\t\t\t\t{\"values\": [{\"code\": \"temp-unknown\"}], \"name\": \"-  Temporarily Unknown\"},\n\t\t\t\t{\"values\": [{\"code\": \"not-asked\"}], \"name\": \"  Not Asked\"},\n\t\t\t\t{\"values\": [{\"code\": \"asked-declined\"}], \"name\": \"-  Asked But Declined\"},\n\t\t\t\t{\"values\": [{\"code\": \"masked\"}], \"name\": \"Masked\"},\n\t\t\t\t{\"values\": [{\"code\": \"not-applicable\"}], \"name\": \"Not Applicable\"},\n\t\t\t\t{\"values\": [{\"code\": \"unsupported\"}], \"name\": \"Unsupported\"},\n\t\t\t\t{\"values\": [{\"code\": \"as-text\"}], \"name\": \"As Text\"},\n\t\t\t\t{\"values\": [{\"code\": \"error\"}], \"name\": \"Error\"},\n\t\t\t\t{\"values\": [{\"code\": \"not-a-number\"}], \"name\": \"-  Not a Number\"},\n\t\t\t\t{\"values\": [{\"code\": \"negative-infinity\"}], \"name\": \"-  Negative Infinity\"},\n\t\t\t\t{\"values\": [{\"code\": \"positive-infinity\"}], \"name\": \"-  Positive Infinity\"},\n\t\t\t\t{\"values\": [{\"code\": \"not-performed\"}], \"name\": \"Not Performed\"},\n\t\t\t\t{\"values\": [{\"code\": \"not-permitted\"}], \"name\": \"Not Permitted\"}\n\t\t\t]\n\t\t}\n\t]\n},{\n\t\"name\": \"Condition\",\n\t\"version\": \"1.0.0.alpha\",\n\t\"tableName\": \"Condition\",\n\t\"patientIdField\": \"subject.reference_id_aa\",\n\t\"fields\": [\n\t\t{\"id\": \"id\", \"type\": \"fhirId\", \"field\": \"id\"},\n\t\t{\"id\": \"clinicalStatus\", \"type\": \"coding\", \"field\": \"clinicalStatus.coding[]\", \"editable\": false,\n\t\t\t\"options\": [\n\t\t\t\t{\"values\": [{\"code\": \"active\"}], \"name\": \"Active\"},\n\t\t\t\t{\"values\": [{\"code\": \"recurrence\"}], \"name\": \"- Recurrence\"},\n\t\t\t\t{\"values\": [{\"code\": \"relapse\"}], \"name\": \"- Relapse\"},\n\t\t\t\t{\"values\": [{\"code\": \"inactive\"}], \"name\": \"Inactive\"},\n\t\t\t\t{\"values\": [{\"code\": \"remission\"}], \"name\": \"- Remission\"},\n\t\t\t\t{\"values\": [{\"code\": \"resolved\"}], \"name\": \"- Resolved\"},\n\t\t\t]\n\t\t},\n\t\t{\"id\": \"verificationStatus\", \"type\": \"coding\", \"field\": \"verificationStatus.coding[]\", \"editable\": false,\n\t\t\t\"options\": [\n\t\t\t\t{\"values\": [{\"code\": \"unconfirmed\"}], \"name\": \"Unconfirmed\"},\n\t\t\t\t{\"values\": [{\"code\": \"provisional\"}], \"name\": \"- Provisional\"},\n\t\t\t\t{\"values\": [{\"code\": \"differential\"}], \"name\": \"- Differential\"},\n\t\t\t\t{\"values\": [{\"code\": \"confirmed\"}], \"name\": \"Confirmed\"},\n\t\t\t\t{\"values\": [{\"code\": \"refuted\"}], \"name\": \"Refuted\"},\n\t\t\t\t{\"values\": [{\"code\": \"entered-in-error\"}], \"name\": \"Entered in Error\"},\n\t\t\t]\n\t\t},\n\t\t{\"id\": \"category\", \"type\": \"coding\", \"field\": \"category[].coding[]\", \"editable\": false,\n\t\t\t\"options\": [\n\t\t\t\t{\"values\": [{\"code\": \"problem-list-item\"}], \"name\": \"Problem List Item\"},\n\t\t\t\t{\"values\": [{\"code\": \"encounter-diagnosis\"}], \"name\": \"Encounter Diagnosis\"},\n\t\t\t\t{\"values\": [{\"code\": \"health-concern\"}], \"name\": \"Health Concern\"},\n\t\t\t]\n\t\t},\n\t\t{\"id\": \"code\", \"type\": \"coding\", \"field\": \"code.coding[]\"}\n\t]\n},{\n\t\"name\": \"Demographics\",\n\t\"version\": \"1.0.0.alpha\",\n\t\"tableName\": \"Patient\",\n\t\"patientIdField\": \"id\",\n\t\"fields\": [\n\t\t{\"id\": \"gender\", \"type\": \"code\", \"field\": \"gender\", \"editable\": false,\n\t\t\t\"options\": [\n\t\t\t\t{\"values\": [{\"code\": \"male\"}], \"name\": \"Male\"},\n\t\t\t\t{\"values\": [{\"code\": \"female\"}], \"name\": \"Female\"},\n\t\t\t\t{\"values\": [{\"code\": \"other\"}], \"name\": \"Other\"},\n\t\t\t\t{\"values\": [{\"code\": \"unknown\"}], \"name\": \"Unknown\"},\n\t\t\t]\n\t\t},\n\t\t{\"id\": \"birthDate\", \"type\": \"date\", \"field\": \"birthDate\"},\n\t\t// {\"name\": \"US Core Race (OMB Category)\", \"id\": \"us-race\", \"type\": \"coding\", \"field\": \"extension[].valueCoding\", \n\t\t// \t\"staticFields\": [{\n\t\t// \t\t\"field\": \"extension[].url\",\n\t\t// \t\t\"value\": \" http://hl7.org/fhir/us/core/StructureDefinition/us-core-race/ombCategory\"\n\t\t// \t}]\n\t\t// },\n\t\t// {\"name\": \"US Core Ethnicity (OMB Category)\", \"id\": \"us-ethnicity\", \"type\": \"coding\", \"field\": \"extension[].valueCoding\", \n\t\t// \t\"staticFields\": [{\n\t\t// \t\t\"field\": \"extension[].url\",\n\t\t// \t\t\"value\": \" http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity/ombCategory\"\n\t\t// \t}]\n\t\t// },\n\n\t]\n\n}]","import definitions from \"./definitions.js\";\n\nexport default {\n\tnextId: 7,\n\tdefinitions: definitions,\n\tview: \"blocks\",\n\tblocks: [{\n\t\tid: \"root\",\n\t\tname: \"All Patients\",\n\t\tparentId: null,\n\t\tdefinition: {\n\t\t\ttableName: \"Patient\",\n\t\t\tpatientIdField: \"id\"\n\t\t}\n\t},{\n\t\tid: 0,\n\t\tnextRuleId: 0,\n\t\tparentId: \"root\",\n\t\tname: \"Demographics\",\n\t\tdefinition: definitions[2],\n\t\tretention: {\n\t\t\tretentionType: \"all\",\n\t\t\tretentionVar: \"pt\"\n\t\t}\n\t},{\n\t\tname: \"DM Dx\",\n\t\tdefinition: definitions[1],\n\t\tparentId: 0,\n\t\tid: 1,\n\t\tnextRuleId: 1,\n\t\trules: [{\n\t\t\tid: 0,\n\t\t\tfieldId: \"code\",\n\t\t\trestrictions: [{\n\t\t\t\tname: \"SNOMED DM\",\n\t\t\t\tsystem: \"http://snomed.info/sct\",\n\t\t\t\tcode: \"105401000119101,106281000119103,10754881000119104,111307005,111552007,123763000,127012008,1481000119100,190330002,190331003,190368000,190372001,190389009,190406000,190407009,190410002,190411003,190412005,199223000,199225007,199226008,199227004,199228009,199229001,199230006,199231005,23045005,237599002,237600004,237601000,237604008,237613005,237618001,237619009,237627000,237651005,24203005,2751001,28032008,31321000119102,313435000,313436004,314771006,314893005,314902007,314903002,314904008,33559001,359642000,368521000119107,408539000,426705001,426875007,427089005,42954008,44054006,445260006,46635009,4783006,51002006,530558861000132104,57886004,59079001,5969009,609561005,609562003,609563008,609564002,609566000,609567009,609568004,609569007,609570008,609571007,609572000,609573005,609574004,609575003,609576002,609577006,609578001,70694009,709147009,710815001,716362006,71791000119104,719216001,720519003,722454003,724136006,73211009,733072002,734022008,75524006,75682002,76751001,81531005,8801005,91352004,9859006\"\n\t\t\t}]\n\t\t}]\n\t},{\n\t\t\"name\": \"Most Recent A1C\",\n\t\t\"retention\": {\n\t\t\t\"retentionType\": \"latest\",\n\t\t\t\"retentionSortField\": \"effectiveDateTimeEnd\",\n\t\t\t\"retentionVar\": \"a1c_latest\"\n\t\t},\n\t\t\"definition\": definitions[0],\n\t\t\"parentId\": 1,\n\t\t\"id\": 2,\n\t\t\"nextRuleId\": 2,\n\t\t\"rules\": [{\n\t\t\t\"id\": 0,\n\t\t\t\"fieldId\": \"status\",\n\t\t\t\"restrictions\": [{\n\t\t\t\t\"option\": \"Final\",\n\t\t\t},{\n\t\t\t\t\"option\": \"Amended\",\n\t\t\t},{\n\t\t\t\t\"option\": \"- Corrected\",\n\t\t\t}]\n\t\t},{\n\t\t\t\"id\": 1,\n\t\t\t\"fieldId\": \"code\",\n\t\t\t\"restrictions\": [{\n\t\t\t\t\"system\": \"http://loinc.org\",\n\t\t\t\t\"code\": \"4548-4\"\n\t\t\t}]\n\t\t}]\n\t},{\n\t\t\"name\": \"Most Recent A1C Elevated\",\n\t\t\"definition\": definitions[0],\n\t\t\"parentId\": 2,\n\t\t\"id\": 3,\n\t\t\"nextRuleId\": 2,\n\t\t\"rules\": [{\n\t\t\t\"id\": 0,\n\t\t\t\"fieldId\": \"id\",\n\t\t\t\"restrictions\": [{\n\t\t\t\t\"target\": \"2.id\",\n\t\t\t}]\n\t\t},{\n\t\t\t\"id\": 1,\n\t\t\t\"fieldId\": \"valueQuantity\",\n\t\t\t\"restrictions\": [{\n\t\t\t\t\"comparator\": \"gte\",\n\t\t\t\t\"compareTo\": \"fixed\",\n\t\t\t\t\"fixedValue\": \"7\",\n\t\t\t\t\"offsetDir\": \"plus\",\n\t\t\t\t\"offsetValue\": 0,\n\t\t\t}]\n\t\t}]\n\t},{\n\t\t\"name\": \"Penultimate A1C\",\n\t\t\"retention\": {\n\t\t\t\"retentionType\": \"latest\",\n\t\t\t\"retentionSortField\": \"effectiveDateTimeEnd\",\n\t\t\t\"retentionVar\": \"a1c_prev\"\n\t\t},\n\t\t\"definition\": definitions[0],\n\t\t\"parentId\": 3,\n\t\t\"id\": 4,\n\t\t\"nextRuleId\": 4,\n\t\t\"rules\": [{\n\t\t\t\"id\": 0,\n\t\t\t\"fieldId\": \"status\",\n\t\t\t\"restrictions\": [{\n\t\t\t\t\"option\": \"Final\",\n\t\t\t},{\n\t\t\t\t\"option\": \"Amended\",\n\t\t\t},{\n\t\t\t\t\"option\": \"- Corrected\",\n\t\t\t}]\n\t\t},{\n\t\t\t\"id\": 1,\n\t\t\t\"fieldId\": \"effectiveDateTimeStart\",\n\t\t\t\"restrictions\": [{\n\t\t\t\t\"comparator\": \"lt\",\n\t\t\t\t\"compareTo\": \"2.effectiveDateTimeStart\",\n\t\t\t\t\"offsetUnit\": \"months\",\n\t\t\t\t\"offsetDir\": \"minus\",\n\t\t\t\t\"offsetValue\": \"1\",\n\t\t\t}]\n\t\t},{\n\t\t\t\"id\": 2,\n\t\t\t\"fieldId\": \"effectiveDateTimeStart\",\n\t\t\t\"restrictions\": [{\n\t\t\t\t\"comparator\": \"gte\",\n\t\t\t\t\"compareTo\": \"0.birthDate\",\n\t\t\t\t\"fixedValue\": \"2020-01-01\",\n\t\t\t\t\"offsetUnit\": \"years\",\n\t\t\t\t\"offsetDir\": \"plus\",\n\t\t\t\t\"offsetValue\": \"18\"\n\t\t\t}]\n\t\t},{\n\t\t\t\"id\": 3,\n\t\t\t\"fieldId\": \"code\",\n\t\t\t\"restrictions\": [{\n\t\t\t\t\"system\": \"http://loinc.org\",\n\t\t\t\t\"code\": \"4548-4\"\n\t\t\t}]\n\t\t}]\n\t},{\n\t\t\"name\": \"Penultimate A1C Elevated\",\n\t\t\"definition\": definitions[0],\n\t\t\"parentId\": 4,\n\t\t\"id\": 5,\n\t\t\"nextRuleId\": 2,\n\t\t\"rules\": [{\n\t\t\t\"id\": 0,\n\t\t\t\"fieldId\": \"id\",\n\t\t\t\"restrictions\": [{\n\t\t\t\t\"target\": \"4.id\",\n\t\t\t}]\n\t\t},{\n\t\t\t\"id\": 1,\n\t\t\t\"fieldId\": \"valueQuantity\",\n\t\t\t\"restrictions\": [{\n\t\t\t\t\"comparator\": \"gte\",\n\t\t\t\t\"compareTo\": \"fixed\",\n\t\t\t\t\"fixedValue\": \"7\",\n\t\t\t\t\"offsetDir\": \"plus\",\n\t\t\t\t\"offsetValue\": 0,\n\t\t\t}]\n\t\t}]\n\t},{\n\t\t\"name\": \"HTN Dx\",\n\t\t\"definition\": definitions[1],\n\t\t\"parentId\": \"root\",\n\t\t\"id\": 7,\n\t\t\"nextRuleId\": 2,\n\t\t\"exclude\": true,\n\t\t\"rules\":[{\n\t\t\t\"id\":0,\n\t\t\t\"fieldId\":\"clinicalStatus\",\n\t\t\t\"restrictions\": [{\n\t\t\t\t\"option\":\"Active\",\n\t\t\t}]\n\t\t},{\n\t\t\t\"id\":1,\n\t\t\t\"fieldId\":\"verificationStatus\",\n\t\t\t\"restrictions\":[{\n\t\t\t\t\"option\":\"Confirmed\"\n\t\t\t}]\n\t\t},{\n\t\t\t\"id\":2,\n\t\t\t\"fieldId\":\"code\",\n\t\t\t\"restrictions\":[{\n\t\t\t\t\"system\":\"http://snomed.info/sct\",\n\t\t\t\t\"name\":\"SNOMED\",\n\t\t\t\t\"code\":\"10725009, 10964002, 1201005, 123799005, 59621000\"\n\t\t\t},{\n\t\t\t\t\"name\":\"ICD-9\",\n\t\t\t\t\"system\":\"http://hl7.org/fhir/ValueSet/icd-9\",\n\t\t\t\t\"code\":\"401.1, 401.9\"\n\t\t\t}]\t\t\n\t\t}]\t\n\t}]\n}","import { createStoreon } from \"storeon\";\nimport definitions from \"./definitions.js\";\nimport dmExample from \"./dm-example\";\n\nconst defaultState = {\n\tnextId: 1,\n\tdefinitions: definitions,\n\tview: \"blocks\",\n\thasTestConfig: false,\n\tblocks: [{\n\t\tid: \"root\",\n\t\tname: \"All Patients\",\n\t\tparentId: null,\n\t\tdefinition: {\n\t\t\ttableName: \"Patient\",\n\t\t\tpatientIdField: \"id\"\n\t\t}\n\t}]\n}\n\nconst actions = store => {\n\tstore.on(\"@init\", () => {\n\t\treturn /example=true/.test(window.location.search)\n\t\t\t? dmExample\n\t\t\t: defaultState;\n\t});\n\t\n\tstore.on(\"block/upsert\", ({nextId, blocks}, {block, insertAbove}) => {\n\t\tconst result = block.id === undefined ? {\n\t\t\tnextId: nextId+1,\n\t\t\tpatients: undefined,\n\t\t\tblocks: blocks.map( b => {\n\t\t\t\treturn b.id === insertAbove\n\t\t\t\t\t? {...b, parentId: nextId+1}\n\t\t\t\t\t: {...b, patients: undefined}\n\t\t\t\t}).concat([{...block, id: nextId+1}])\n\t\t\t} : {\n\t\t\t\tpatients: undefined,\n\t\t\t\tblocks: blocks.map( b => {\n\t\t\t\t\tif (block.id !== b.id) {\n\t\t\t\t\t\treturn {...b, patients: undefined}\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn {...b, ...block, patients: undefined};\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t}\n\t\tconsole.log(result)\n\t\treturn result;\n\t});\n\n\tstore.on(\"block/delete\", ({blocks}, {id, parentId}) => {\n\t\tconst result =  {\n\t\t\tpatients: undefined,\n\t\t\tblocks: blocks\n\t\t\t\t.map( b => b.parentId === id\n\t\t\t\t\t? {...b, parentId, patients: undefined}\n\t\t\t\t\t: {...b, patients: undefined}\n\t\t\t\t)\t\n\t\t\t\t.filter( b => b.id !== id)\n\t\t\t\t.map( b => ({\n\t\t\t\t\t...b,\n\t\t\t\t\trules: b.rules && b.rules.map( r => ({\n\t\t\t\t\t\t...r,\n\t\t\t\t\t\trestrictions: r.restrictions && r.restrictions.filter( rs => {\n\t\t\t\t\t\t\treturn (!rs.target || rs.target.split(\".\")[0] !== id.toString()) &&\n\t\t\t\t\t\t\t\t(!rs.compareTo || rs.compareTo.split(\".\")[0] !== id.toString())\n\t\t\t\t\t\t})\n\t\t\t\t\t}))\n\t\t\t\t}))\n\t\t}\n\t\treturn result;\n\t});\n\n\tstore.on(\"view/set\", ({}, view) => {\n\t\treturn {view}\n\t});\n\n\tstore.on(\"hasTestConfig/set\", ({}, hasTestConfig) => {\n\t\treturn {hasTestConfig}\n\t});\n\n\tstore.on(\"patients/set\", ({blocks}, result) => {\n\t\tif (!result) return {\n\t\t\tpatients: undefined, \n\t\t\tblocks: blocks.map( b => ({...b, patients: undefined}) )\n\t\t}\n\t\tconst blockResults = result[0].values.reduce( (acc, row) => {\n\t\t\treturn {...acc, [row[0]]: row[1]}\n\t\t}, {});\n\t\treturn {\n\t\t\tpatients: blockResults[\"result\"],\n\t\t\tblocks: blocks.map( b => {\n\t\t\t\treturn {...b, patients: blockResults[b.id.toString()]}\n\t\t\t})\n\t\t}\n\n\t});\n\n}\n\nconst store = createStoreon([actions]);\nexport default store;","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport {StoreContext} from 'storeon/react'\nimport store from \"./store\";\n// import * as serviceWorker from './serviceWorker';\n\nReactDOM.render(\n  <React.StrictMode>\n    <StoreContext.Provider value={store}>\n      <App />\n    </StoreContext.Provider>\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\n// serviceWorker.unregister();\n"],"sourceRoot":""}