(this["webpackJsonpa3-ui"]=this["webpackJsonpa3-ui"]||[]).push([[0],{75:function(e,t,a){e.exports=a(87)},80:function(e,t,a){},81:function(e,t,a){},87:function(e,t,a){"use strict";a.r(t);var n=a(0),i=a.n(n),r=a(21),o=a.n(r),l=(a(80),a(81),a(101)),c=a(69),d=a(99),s=a(64),u=a(102),m=a(103),f=a(18),p=a(7),v=a(100),E=a(92),b=a(104),g=a(93),h=a(94),y=a(23),O=a.n(y);function N(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if("string"===typeof e)return"\t".repeat(a)+(t?t+" ":"")+e;if(0!==e.criteria.length){if(1===e.criteria.length)return N(e.criteria[0],a>0?t:null,a);var n=e.criteria.map((function(t,n){return N(t,n>0?e.type:null,a+1)})).filter((function(e){return!!e}));return 0===a?n.join("\n"):n.length?"\t".repeat(a)+(t?t+" (\n":"(\n")+n.join("\n")+"\n"+"\t".repeat(a)+")":void 0}}function j(e,t){var a="f_".concat(t,"_");if(-1===e.field.indexOf("[]"))return{select:["json_extract(res.json, '$.".concat(e.field,"') ").concat(a).concat(e.id)]};var n,i=[],r=[],o=e.field.match(/[^\[]+\[\]/g);return o.forEach((function(t,i){var l=a+(i<o.length-1?t.replace(/\[\]/g,"").replace(/\./g,"_"):e.id),c=t.replace(/(^\.?)|(\[\]$)/g,"");r.push("JOIN json_each(json_extract(".concat(n||"res.json",", '$.").concat(c,"')) ").concat(l," ON 1=1")),n=l})),i.push("".concat(n,".value ").concat(n)),{select:i,join:r}}function T(e,t){var a={gte:">= ",lte:"<= ",gt:"> ",lt:"<  ",eq:"= ",populated:"IS NOT NULL",not_populated:"IS NULL"}[e.comparator],n=-1===e.comparator.indexOf("populated"),i={type:"AND",criteria:[]};if("populated"===e.comparator||"not_populated"===e.comparator||"fixed"===e.compareTo)i.criteria.push("json_extract(".concat(t,", '$.value') ").concat(a+(n?e.fixedValue:""))),e.unitSystem&&i.criteria.push("json_extract(".concat(t,", '$.system') = '").concat(e.unitSystem,"'")),e.unitCode&&i.criteria.push("json_extract(".concat(t,", '$.code') = '").concat(e.unitCode,"'"));else{var r=e.compareTo.split("."),o=Object(p.a)(r,2),l=o[0],c=o[1],d=e.offsetValue?"".concat("minus"===e.offsetDir?NaN:"+"," ").concat(e.offsetValue):"";i.criteria.push("json_extract(".concat(t,", '$.value') ").concat(a," json_extract(block_").concat(l,".f_").concat(l,"_").concat(c,", '$.value') ").concat(d),"(\n\t\t\t\t(json_extract(block_".concat(l,".f_").concat(l,"_").concat(c,", '$.system') IS NULL AND json_extract(").concat(t,", '$.system') IS NULL)\n\t\t\t\tOR json_extract(").concat(t,", '$.system') = json_extract(block_").concat(l,".f_").concat(l,"_").concat(c,", '$.system')\n\t\t\t)"),"(\n\t\t\t\t(json_extract(block_".concat(l,".f_").concat(l,"_").concat(c,", '$.code') IS NULL AND json_extract(").concat(t,", '$.code') IS NULL)\n\t\t\t\tOR json_extract(").concat(t,", '$.code') = json_extract(block_").concat(l,".f_").concat(l,"_").concat(c,", '$.code')\n\t\t\t)"))}return i}function I(e,t){var a={type:"AND",criteria:[]},n=e.code.split(/\s*,\s*/).map((function(e){return"'".concat(e,"'")})).join(",");return e.name&&(a.comment=e.name),e.system&&a.criteria.push("json_extract(".concat(t,".value, '$.system') = '").concat(e.system,"'")),a.criteria.push("json_extract(".concat(t,".value, '$.code') IN (").concat(n,")")),a}function D(e,t){return"".concat(t," = '").concat(e.code,"'")}function C(e,t){var a,n={gte:">= ",lte:"<= ",gt:"> ",lt:"<  ",eq:"= ",populated:"IS NOT NULL",not_populated:"IS NULL"}[e.comparator],i=-1===e.comparator.indexOf("populated");if("populated"===e.comparator||"not_populated"===e.comparator||"fixed"===e.compareTo)return"DATETIME(".concat(t,") ").concat(n+(i?"DATETIME('"+e.fixedValue+"')":""));if("run"===e.compareTo)a="'NOW'";else{var r=e.compareTo.split("."),o=Object(p.a)(r,2),l=o[0],c=o[1];a="block_".concat(l,".f_").concat(l,"_").concat(c)}if(e.offsetValue){var d="'".concat("minus"===e.offsetDir?"-":"+").concat(e.offsetValue," ").concat(e.offsetUnit,"'");return"DATETIME(".concat(t,") ").concat(n," DATETIME(").concat(a,", ").concat(d,")")}return"DATETIME(".concat(t,") ").concat(n," DATETIME(").concat(a,")")}var k={buildSql:function(e,t,a){var n=[],i=function(e){var t={};e.forEach((function(a){if(t[a.id]=t[a.id]||{fields:{},joinTargets:{},id:a.id,parentId:a.parentId,name:a.name,tableName:a.definition&&a.definition.tableName,patientIdField:a.definition&&a.definition.patientIdField,resourceIdField:a.definition&&(a.definition.resourceIdField||"id")},null===a.parentId||t[a.id].joinTargets[a.id]||"root"===a.parentId||(t[a.id].joinTargets[a.parentId]="patient_id"),(a.rules||[]).forEach((function(n){var i=a.definition.fields.find((function(e){return e.id===n.fieldId}));t[a.id].fields[n.fieldId]=t[a.id].fields[n.fieldId]||{},t[a.id].fields[n.fieldId].restrictions=t[a.id].fields[n.fieldId].restrictions||[],t[a.id].fields[n.fieldId].restrictions.push(n.restrictions),t[a.id].fields[n.fieldId].definition=i,t[a.id].isLeaf=0===e.filter((function(e){return e.parentId===a.id})).length,t[a.id].exclude=a.exclude,n.restrictions.forEach((function(n){if(n.compareTo&&"fixed"!==n.compareTo&&"run"!==n.compareTo&&-1===n.comparator.indexOf("populated")){var r=n.compareTo.split("."),o=Object(p.a)(r,2),l=o[0],c=o[1];t[l]=t[l]||{fields:{},joinTargets:{}},t[l].fields[c]=t[l].fields[c]||{},t[l].fields[c].export=!0;var d=e.find((function(e){return e.id===parseInt(l)})).definition.fields.find((function(e){return e.id===c}));t[l].fields[c].definition=d,t[a.id].joinTargets[l]||(t[a.id].joinTargets[l]="patient_id")}else if(n.target&&"fhirId"===i.type){var s=n.target.split("."),u=Object(p.a)(s,2),m=u[0];u[1];t[a.id].joinTargets=t[a.id].joinTargets||{},t[a.id].joinTargets[m]="resource_id"}}))})),a.retention&&"none"!==a.retention.retentionType&&"all"!==a.retention.retentionType){var n=a.retention.retentionSortField;if(t[a.id].retentionSortField=n,t[a.id].retentionSortDir="latest"===a.retention.retentionType?"DESC":"ASC",!t[a.id].fields[n]){var i=a.definition.fields.find((function(e){return e.id===n}));t[a.id].fields[n]={definition:i}}}})),t.root||(t.root={id:"root",tableName:"Patient",patientIdField:"id"});var a=[];return function n(i){void 0!==i&&t[i]&&a.push(t[i]),e.filter((function(e){return e.parentId===i})).forEach((function(e){return n(e.id)}))}("root"),a}(e);return i.forEach((function(e){if(e.tableName&&void 0!==e.parentId){var t={join:[],select:[],where:[]};Object.keys(e.joinTargets).forEach((function(a){var n=e.joinTargets[a];t.join.push("INNER JOIN block_".concat(a," ON block_").concat(a,".f_").concat(a,"_").concat(n," = f_").concat(e.id,"_").concat(n))})),t.select.push(j({field:e.patientIdField||"subject.reference",id:"patient_id"},e.id).select,j({field:e.resourceIdField||"id",id:"resource_id"},e.id).select),Object.keys(e.fields).forEach((function(a){var n=e.fields[a];if("fhirId"!==n.type){var i=j(n.definition,e.id),r=i.join,o=i.select;if(r&&(t.join=t.join.concat(r)),o&&(t.select=t.select.concat(o)),n.restrictions){var l=function(e,t){var a={code:D,coding:I,quantity:T,date:C}[e.definition.type];if(a){var n="f_"+t+"_"+e.definition.id,i={type:"AND",criteria:[]};return e.restrictions.forEach((function(t){var r={type:"OR",criteria:[]};t.forEach((function(t){if(t.option){var i=e.definition.options.find((function(e){return e.name===t.option})).values.map((function(e){return a(e,n)}));r.criteria=r.criteria.concat(i)}else{var o=a(t,n);r.criteria.push(o)}})),r.criteria.length&&i.criteria.push(r)})),i.criteria.length?i:null}}(n,e.id);l&&t.where.push(l)}}}));var i=t.where.length?N({type:"AND",criteria:t.where}):"",r=t.select.join(",\n\t"),o=t.join.join("\n\t"),l="SELECT\n\t".concat(r,"\nFROM\n\t").concat(e.tableName," res")+(o.length?"\n\t".concat(o):"")+(i.length?"\nWHERE\n\t".concat(i):"");e.retentionSortField&&(l=function(e,t){return"SELECT outer.* FROM (\n\t\tSELECT inner.*,\n\t\t\tdense_rank() over (\n\t\t\t\tpartition by inner.f_".concat(e.id,"_patient_id\n\t\t\t\torder by inner.f_").concat(e.id,"_").concat(e.retentionSortField," ").concat(e.retentionSortDir,"\n\t\t\t) as rank\n\t\t\tFROM (\n\t\t\t\t").concat(t.replace(/\n/g,"\n\t\t\t\t"),"\n\t\t\t) AS inner\n) AS outer WHERE outer.rank = 1")}(e,l));var c=a?null:e.name;n.push(function(e,t,a){var n=a?["-- "+a]:[];return n.push("DROP TABLE IF EXISTS block_".concat(e,";"),"CREATE TEMPORARY TABLE block_".concat(e," AS"),"".concat(t,";")),n.join("\n")}(e.id,l,c))}})),n.push(function(e){var t,a=e.find((function(e){return"root"===e.id})),n=e.filter((function(e){return e.isLeaf&&e.exclude})),i=e.filter((function(e){return e.isLeaf&&!e.exclude}));return n&&!i.length?t=["SELECT DISTINCT(json_extract(res.json, '$.".concat(a.patientIdField||"id","')) list_patient_id \nFROM ").concat(a.tableName," res")]:i.length&&(t=i.map((function(e,t){return"".concat(t>0?"UNION ":"","SELECT DISTINCT(block_").concat(e.id,".f_").concat(e.id,"_patient_id) list_patient_id FROM block_").concat(e.id)}))),t=t.concat(n.map((function(e){return"EXCEPT SELECT DISTINCT(block_".concat(e.id,".f_").concat(e.id,"_patient_id) list_patient_id FROM block_").concat(e.id)}))),["-- Patient List","DROP TABLE IF EXISTS patient_list;","CREATE TEMPORARY TABLE patient_list AS"].concat(t).join("\n")+";"}(i)),t?n.push(function(e){var t=e.find((function(e){return"root"===e.id}));if(t){var a=["SELECT 'root' block, COUNT(DISTINCT json_extract(".concat(t.tableName,".json, '$.").concat(t.patientIdField||"id","')) patients FROM ").concat(t.tableName),"SELECT 'result' block, COUNT(DISTINCT list_patient_id) patients FROM patient_list"];e.forEach((function(e){"root"!==e.id&&a.push("SELECT ".concat(e.id," block, COUNT(DISTINCT f_").concat(e.id,"_patient_id) patients FROM block_").concat(e.id))}));return"-- Block Counts\n"+a.join("\nUNION ALL\n")+";"}}(i)):n.push(function(e){var t=e.find((function(e){return"root"===e.id}));if(t)return"SELECT list_patient_id, ".concat(t.tableName,".json FROM patient_list\n\t\tINNER JOIN ").concat(t.tableName,"\n\t\tON patient_list.list_patient_id = json_extract(").concat(t.tableName,".json, '$.").concat(t.patientIdField||"id","');")}(i)),n.join("\n\n")},whereToSql:N,buildDate:C,buildQuantity:T,buildCode:D,buildCoding:I},x=function(e){var t=e.children,a=e.dropHint,r=e.fileDropHandler,o=Object(n.useState)(0),l=Object(p.a)(o,2),c=l[0],d=l[1],s=function(e){return!e.dataTransfer.types||"Files"===e.dataTransfer.types[0]||"application/x-moz-file"===e.dataTransfer.types[0]},u=i.a.createElement("div",{className:"d-flex justify-content-center",style:{border:"dashed grey 4px",backgroundColor:"rgba(255,255,255,.8)",position:"absolute",top:0,bottom:0,left:0,right:0,zIndex:9999}},i.a.createElement("div",{className:"d-flex align-items-center"},a||"Drop NDJSON or SQLITE DB file here"));return i.a.createElement("div",{style:{position:"relative"},onDragEnter:function(e){e.preventDefault(),e.stopPropagation(),s(e)&&d(c+1)},onDragOver:function(e){e.preventDefault(),e.stopPropagation()},onDragLeave:function(e){e.preventDefault(),e.stopPropagation(),s(e)&&d(c-1)},onDrop:function(e){e.preventDefault(),e.stopPropagation(),e.dataTransfer.files&&1===e.dataTransfer.files.length&&r(e.dataTransfer.files[0]),d(0)}},c>0&&u,t)};var _=function(e){var t=Object(f.b)("blocks"),r=t.blocks,o=t.dispatch,c=Object(n.useState)("loading_sqlite"),d=Object(p.a)(c,2),u=d[0],m=d[1],y=Object(n.useState)("local"),N=Object(p.a)(y,2),j=N[0],T=N[1],I=Object(n.useState)(),D=Object(p.a)(I,2),C=D[0],_=D[1],S=Object(n.useState)(),w=Object(p.a)(S,2),R=w[0],L=w[1],F=Object(n.useState)(),A=Object(p.a)(F,2),V=A[0],U=A[1],q=Object(n.useState)(),B=Object(p.a)(q,2),P=B[0],M=B[1],H=Object(n.useState)(),$=Object(p.a)(H,2),Q=$[0],z=$[1],J=Object(n.useRef)(null),Y=Object(n.useRef)(),G=Object(n.useRef)();if(Object(n.useEffect)((function(){if("test-run"===e.mode)return m("running_query");e.show&&!Y.current&&Promise.all([a.e(2),a.e(4)]).then(a.t.bind(null,295,7)).then((function(e){Y.current=e.default(),Y.current.then((function(){return fetch("bulk.db",{method:"HEAD"})})).then((function(e){G.current=!!e.ok,G.current&&"built-in"===j?ee():(T("local"),m("no_data"))})).catch((function(e){console.log(e),z("Error loading SQL engine"),m("error")}))}))}),[e.show]),Object(n.useEffect)((function(){"running_query"===u&&window.setTimeout((function(){new Promise((function(e,t){try{var a=k.buildSql(r,!0);e(R.exec(a))}catch(n){t(n)}})).then((function(e){m("data_loaded"),o("patients/set",e)})).then((function(){o("view/set","blocks")})).catch((function(e){z("Query failed: "+e.message),m("error")}))}),500)}),[u]),!e.show)return null;var W=function(e){var t=e.exec("SELECT name FROM sqlite_master\n\t\t\tWHERE type = 'table' AND name NOT LIKE 'sqlite_%'\n\t\t\tORDER BY name asc\n\t\t");if(!t[0])throw{message:"No tables found"};var a=t[0].values.map((function(e){return"SELECT '".concat(e[0],"' name, COUNT() records FROM ").concat(e[0])}));return e.exec(a.join(" UNION ALL "))[0].values},X=function(e){Y.current.then((function(t){var a=new t.Database,n=function(e){if(!e.find((function(e){return"Patient"===e.resourceType})))throw{message:"No patient resources found"};return O.a.chain(e).groupBy("resourceType").mapValues((function(e,t){var a=e.map((function(e){return"('"+JSON.stringify(e)+"')"}));return["CREATE TABLE ".concat(t,"(json)"),"INSERT INTO ".concat(t," VALUES ").concat(a.join(","))]})).values().flatten().join("; ").value()}(e);a.run(n),U(W(a)),m("data_loaded"),o("hasTestConfig/set",!0),L(a)})).catch((function(e){console.log(e),z("Error loading FHIR data: "+e.message),_(null),m("error")}))},Z=function(e){Y.current.then((function(t){var a=new t.Database(e);U(W(a)),L(a),m("data_loaded"),o("hasTestConfig/set",!0)})).catch((function(e){console.log(e),z("Error loading FHIR data: "+e.message),_(null),m("error")}))},K=function(e){var t=e.name.split(".")[e.name.split(".").length-1];_(e.name),m("loading_data"),T("local");var a=new FileReader;a.onerror=function(e){_(null),z("Error reading data file"),m("error")},a.onloadend=function(n){if(e.size>1e6&&"ndjson"===t)_(null),z("File is too large - please limit NDJSON files to size to 1mb"),m("error");else if("ndjson"===t){var i=n.target.result.replace(/\'/g,"''").trim().split("\n").map((function(e){return JSON.parse(e)}));X(i)}else{var r=new Uint8Array(a.result);Z(r)}},"ndjson"===t?a.readAsText(e):a.readAsArrayBuffer(e)},ee=function(){m("loading_data"),fetch("bulk.db").then((function(e){return e.arrayBuffer()})).then((function(e){var t=new Uint8Array(e);Z(t)})).catch((function(e){console.log(e),z("Error reading data file"),m("error")}))},te=function(e,t){e.preventDefault(),M(t)};return i.a.createElement("div",null,i.a.createElement("input",{type:"file",ref:J,style:{display:"none"},accept:".ndjson,.sqlite,.db",onChange:function(e){var t=J.current.files[0];t&&K(t)}}),i.a.createElement(v.a,{background:"static",show:!0,animation:!1,size:"lg",onHide:function(e){if("loading_sqlite"===u||"loading_data"===u||"running_query"===u)return!1;o("view/set","blocks")}},i.a.createElement(v.a.Header,{closeButton:!0},i.a.createElement(v.a.Title,null,"Test Query")),i.a.createElement(v.a.Body,null,i.a.createElement(x,{fileDropHandler:K},"error"===u&&i.a.createElement(E.a,{variant:"danger"},Q),"loading_data"!==u&&"running_query"!==u&&"loading_sqlite"!==u&&i.a.createElement("div",null,i.a.createElement(l.a.Group,null,i.a.createElement(l.a.Control,{as:"select",value:j,onChange:function(e){"built-in"===e.target.value?(T("built-in"),ee()):(T("local"),m("no_data"),o("hasTestConfig/set",!1))}},i.a.createElement("option",{value:"local"},"Local Dataset"),G.current&&i.a.createElement("option",{value:"built-in"},"Test Dataset"))),"local"===j&&i.a.createElement(b.a,null,i.a.createElement(b.a.Body,null,i.a.createElement("div",{className:"font-weight-bold mb-2"},"A3 Annotated FHIR Data (NDJSON or SQLITE DB)"),i.a.createElement("div",null,i.a.createElement(s.a,{size:"sm",variant:"success",onClick:function(e){J.current.click()},className:"mr-2"},C?"Change File":"Choose File"),i.a.createElement("span",null,C))))),"data_loaded"===u&&V&&!P&&i.a.createElement("div",{className:"m-2"},i.a.createElement("a",{href:"#",onClick:function(e){return te(e,!0)}},"show detail")),"data_loaded"===u&&V&&P&&i.a.createElement("div",{className:"mx-4"},i.a.createElement(g.a,{size:"sm"},i.a.createElement("thead",null,i.a.createElement("tr",{className:"font-weight-bold"},i.a.createElement("td",null,"Resource"),i.a.createElement("td",{className:"text-right"},"Records"))),i.a.createElement("tbody",null,V.map((function(e){return i.a.createElement("tr",{key:e[0]},i.a.createElement("td",null,e[0]),i.a.createElement("td",{className:"text-right"},e[1].toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")))})))),i.a.createElement("a",{href:"#",onClick:te,className:"mt-1"},"hide detail")),("loading_sqlite"===u||"loading_data"===u||"running_query"===u)&&i.a.createElement("div",{className:"my-2 text-center"},i.a.createElement(h.a,{animation:"border",role:"status"}),"loading_sqlite"!==u&&i.a.createElement("div",{className:"mt-1 font-weight-bold"},"loading_data"===u?"Loading Data":"Running Query")),"data_loaded"===u&&i.a.createElement("div",{className:"m-2 mt-4 text-right"},"data_loaded"===u&&i.a.createElement(s.a,{onClick:function(e){m("running_query")}},"Run Query!"))))))},S=a(95),w=a(63);var R=function(){var e=Object(f.b)(["blocks"]),t=e.blocks,a=e.dispatch,r=Object(n.useState)(),o=Object(p.a)(r,2),c=o[0],d=o[1],u=Object(n.useState)(!0),m=Object(p.a)(u,2),E=(m[0],m[1],Object(n.useRef)(null)),b=Object(n.useState)(),g=Object(p.a)(b,2),h=g[0],y=g[1];return Object(n.useEffect)((function(){y(k.buildSql(t,!0))}),[]),i.a.createElement(v.a,{show:!0,animation:!1,size:"lg",onHide:function(e){return a("view/set","blocks")}},i.a.createElement(v.a.Header,{closeButton:!0},i.a.createElement(v.a.Title,null,"Export SQL")),i.a.createElement(v.a.Body,null,i.a.createElement(l.a.Group,{as:S.a,className:"align-items-center"},i.a.createElement(w.a,{xs:"auto"},i.a.createElement(l.a.Label,null,"Format")),i.a.createElement(w.a,null,i.a.createElement(l.a.Control,{as:"select",onChange:function(e){d("")}},i.a.createElement("option",null,"Sqlite")))),i.a.createElement(l.a.Control,{as:"textarea",rows:6,ref:E,defaultValue:h,readOnly:!0,style:{backgroundColor:"#FFF",fontFamily:"monospace,monospace",whiteSpace:"pre"}})),i.a.createElement(v.a.Footer,{className:"align-items-center"},i.a.createElement("div",{className:"mr-auto my-auto ml-2"},c),i.a.createElement(s.a,{variant:"outline-primary",onClick:function(e){E.current.select(),document.execCommand("copy"),e.target.focus(),d("Copied!")}},"Copy to Clipboard"),i.a.createElement(s.a,{onClick:function(e){if("undefined"!=typeof Blob){var t=new Blob([h],{type:"text/plain"}),a=document.createElement("a");a.download="query.sql",null!=window.webkitURL?a.href=window.webkitURL.createObjectURL(t):(a.href=window.URL.createObjectURL(t),a.onclick=function(e){return document.body.removeChild(e.target)},a.style.display="none",document.body.appendChild(a)),a.click()}else{var n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(h)),n.setAttribute("download","query.sql"),n.onclick=function(e){return document.body.removeChild(e.target)},n.click()}}},"Download")))},L=a(5),F=a(97),A=a(98),V=a(60),U=a(11),q=a(12),B=a(13);var P=function(e){var t={comparator:[{value:"populated",display:"Populated"},{value:"not_populated",display:"Not Populated"},{value:"eq",display:"Equal To"},{value:"lt",display:"Before"},{value:"lte",display:"Before (Inclusive)"},{value:"gt",display:"After"},{value:"gte",display:"After (Inclusive)"}],compareTarget:[{value:"run",display:"Query Run Date"},{value:"fixed",display:"Fixed Date"}],offsetDir:[{value:"plus",display:"+"},{value:"minus",display:"-"}],offsetUnit:[{value:"minutes",display:"Minutes"},{value:"hours",display:"Hours"},{value:"days",display:"Days"},{value:"months",display:"Months"},{value:"years",display:"Years"}]},a=function(t,a){var n=Object(L.a)(Object(L.a)({},e.data),{},Object(U.a)({},t,a)),i=function(e){var t=-1===e.comparator.indexOf("populated")&&"fixed"===e.compareTo&&!/^\d{4}-\d{2}-\d{2}$/.test(e.fixedValue);return t&&{fixedValue:t}}(n);e.onUpdate(Object(L.a)(Object(L.a)({},n),{},{invalid:i}))},n=function(e){return t[e].map((function(e){return i.a.createElement("option",{value:e.value,key:e.value},e.display)}))},r=e.data.comparator&&-1!==e.data.comparator.indexOf("populated");return e.edit?i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"my-2"},i.a.createElement("span",{className:"mr-1 font-weight-bold"},e.fieldDefinition.name||e.fieldDefinition.id),i.a.createElement("span",null,"is"),!e.hideControls&&i.a.createElement(q.a,{icon:B.b,opacity:"0.5",onClick:function(t){return e.onDelete(e.id)},style:{cursor:"pointer"},pull:"right"})),i.a.createElement("div",{className:"my-2"},i.a.createElement("select",{className:"form-control",value:e.data.comparator||"gt",onChange:function(e){return a("comparator",e.target.value)}},n("comparator"))),!r&&function(){var t=e.data.validate&&e.data.invalid;return i.a.createElement("div",{className:"my-2 form-row"},i.a.createElement(w.a,null,i.a.createElement("select",{className:"form-control",value:e.data.compareTo||"fixed",onChange:function(e){return a("compareTo",e.target.value)}},n("compareTarget"),(e.relativeOptions||[]).sort().map((function(e){return i.a.createElement("option",{key:e.value,value:e.value},e.label)})))),(!e.data.compareTo||"fixed"===e.data.compareTo)&&i.a.createElement(w.a,null,i.a.createElement("input",Object(U.a)({type:"date",className:"form-control",required:!0,value:e.data.fixedValue||"",onChange:function(e){return a("fixedValue",e.target.value)}},"className",t?"is-invalid form-control":"form-control"))))}(),!r&&"fixed"!==e.data.compareTo&&i.a.createElement("div",{className:"my-2 form-row"},i.a.createElement(w.a,null,i.a.createElement("select",{className:"form-control",value:e.data.offsetDir||"plus",onChange:function(e){return a("offsetDir",e.target.value)}},n("offsetDir"))),i.a.createElement(w.a,null,i.a.createElement("input",{type:"number",className:"form-control",value:e.data.offsetValue||"",required:!0,onChange:function(e){return a("offsetValue",e.target.value)}})),i.a.createElement(w.a,null,i.a.createElement("select",{className:"form-control",value:e.data.offsetUnit||"years",onChange:function(e){return a("offsetUnit",e.target.value)}},n("offsetUnit"))))):function(){var a=function(){if(e.data.offsetValue)return i.a.createElement("span",{className:"mr-1 mt-1 mark"},n("offsetDir",e.data.offsetDir)," ",e.data.offsetValue," ",n("offsetUnit",e.data.offsetUnit))},n=function(e,a){return t[e].find((function(e){return e.value===a})).display},o=!r&&e.data.compareTo.indexOf(".")>-1&&e.relativeOptions.find((function(t){return t.value===e.data.compareTo})).label;return i.a.createElement("div",null,!e.hideControls&&i.a.createElement(q.a,{icon:B.a,opacity:"0.5",style:{cursor:"pointer"},pull:"right",className:"m-1"}),i.a.createElement("div",{style:{lineHeight:2}},i.a.createElement("span",{className:"mt-1 mr-1 font-weight-bold"},e.fieldDefinition.name||e.fieldDefinition.id),i.a.createElement("span",{className:"mt-1 mr-1"},"is"),i.a.createElement("span",{className:"mt-1 mr-1 mark"},n("comparator",e.data.comparator).toLowerCase()),!r&&"fixed"===e.data.compareTo&&i.a.createElement(i.a.Fragment,null,i.a.createElement("span",{className:"mt-1 mr-1 mark"},"fixed value"),i.a.createElement("span",{className:"mt-1 mr-1"},"of"),i.a.createElement("span",{className:"mt-1 mr-1 mark"},e.data.fixedValue)),!r&&"run"===e.data.compareTo&&i.a.createElement(i.a.Fragment,null,i.a.createElement("span",{className:"mt-1 mr-1 mark"},"Query Run Date"),a()),!r&&e.data.compareTo.indexOf(".")>-1&&i.a.createElement(i.a.Fragment,null,i.a.createElement("span",{className:"d-inline-block"},i.a.createElement("span",{className:"mt-1 mr-1 mark"},o)),a())))}()};var M=function(e){var t=function(t,a){var n=Object(L.a)(Object(L.a)({},e.data),{},Object(U.a)({},t,a)),i=function(t){var a=(!e.fieldDefinition.options||"__custom"===t.option)&&0===(t.code||"").replace(/[\s,]/g).length;return a&&{code:a}}(n);e.onUpdate(Object(L.a)(Object(L.a)({},n),{},{invalid:i}))},a=function(){return"code"===e.fieldDefinition.type?i.a.createElement("div",null,i.a.createElement("div",{className:"my-2"},i.a.createElement("span",{className:"mr-1 font-weight-bold"},e.fieldDefinition.name||e.fieldDefinition.id),i.a.createElement("span",null,"matches the code"),!e.hideControls&&i.a.createElement(q.a,{icon:B.b,opacity:"0.5",onClick:function(t){return e.onDelete(e.id)},style:{cursor:"pointer"},pull:"right"})),i.a.createElement("div",{className:"form-group"},i.a.createElement("input",Object(U.a)({className:"form-control",value:e.data.code||"",onChange:function(e){return t("code",e.target.value)}},"className",e.data.invalid&&e.data.validate?"is-invalid form-control":"form-control")))):i.a.createElement("div",null,n(),i.a.createElement("div",{className:"form-group"},i.a.createElement("label",null,"Name (optional)"),i.a.createElement("input",{className:"form-control",value:e.data.name||"",onChange:function(e){return t("name",e.target.value)}})),i.a.createElement("div",{className:"form-group"},i.a.createElement("label",null,"System (optional)"),i.a.createElement("input",{className:"form-control",value:e.data.system||"",placeholder:"http://loinc.org",onChange:function(e){return t("system",e.target.value)}})),i.a.createElement("div",{className:"form-group"},i.a.createElement("label",null,"Codes (comma separated)"),i.a.createElement("textarea",{value:e.data.code||"",onChange:function(e){return t("code",e.target.value)},className:e.data.invalid&&e.data.validate?"is-invalid form-control":"form-control"})))},n=function(){return i.a.createElement("div",{className:"my-2"},i.a.createElement("span",{className:"mr-1 font-weight-bold"},e.fieldDefinition.name||e.fieldDefinition.id),i.a.createElement("span",null,"matches at least one code in"),!e.hideControls&&i.a.createElement(q.a,{icon:B.b,opacity:"0.5",onClick:function(t){return e.onDelete(e.id)},style:{cursor:"pointer"},pull:"right"}))};return e.edit?"__custom"!==e.data.option&&e.fieldDefinition.options?function(){var a=(e.fieldDefinition.options.find((function(t){return t.name===e.data.name&&t.system===e.data.system&&t.code===e.data.code}))||{}).name;return i.a.createElement("div",null,i.a.createElement("div",{className:"my-2"},i.a.createElement("span",{className:"mr-1 font-weight-bold"},e.fieldDefinition.name||e.fieldDefinition.id),i.a.createElement("span",null,"is"),!e.hideControls&&i.a.createElement(q.a,{icon:B.b,opacity:"0.5",onClick:function(t){return e.onDelete(e.id)},style:{cursor:"pointer"},pull:"right"})),i.a.createElement("select",{value:e.data.option||"",onChange:function(e){return t("option",e.target.value)},className:e.data.invalid&&e.data.validate?"is-invalid form-control":"form-control"},!a&&i.a.createElement("option",{value:""}),e.fieldDefinition.options.map((function(e){return i.a.createElement("option",{value:e.name,key:e.name},function(e){var t=(e.code||"").split(",").length,a=t>1?" (".concat(t," codes)"):"";return e.name+a}(e))})),e.fieldDefinition.editable&&i.a.createElement("option",{value:"__custom",key:"__custom"},"Custom")))}():a():function(){var t=e.data.code?e.data.code.split(",").length:0,a=e.data.option&&"__custom"!==e.data.option&&e.data.option.replace(/^[ -]*/,"")||e.data.name||1===t&&e.data.code||"Unnamed";return i.a.createElement("div",null,!e.hideControls&&i.a.createElement(q.a,{icon:B.a,opacity:"0.5",style:{cursor:"pointer"},pull:"right",className:"m-1"}),i.a.createElement("div",{style:{lineHeight:2}},i.a.createElement("span",{className:"mt-1 mr-1 font-weight-bold"},e.fieldDefinition.name||e.fieldDefinition.id),t>1?" matches at least one code in valueset ":" matches code ",i.a.createElement("span",{className:"mark mt-1"},a),t>1&&i.a.createElement("span",{className:"mt-1"},"(",t," codes)")))}()},H=a(96),$=a(65);var Q=function(e){return e.edit?i.a.createElement("div",null,i.a.createElement("div",{className:"my-2"},i.a.createElement("span",{className:"mr-1 font-weight-bold"},e.fieldDefinition.name||e.fieldDefinition.id),i.a.createElement("span",null,"is equal to"),!e.hideControls&&i.a.createElement(q.a,{icon:B.b,opacity:"0.5",onClick:function(t){return e.onDelete(e.id)},style:{cursor:"pointer"},pull:"right"})),i.a.createElement("select",{value:e.data.target,className:e.data.validate&&!e.data.target?"is-invalid form-control":"form-control",onChange:function(t){return function(t,a){var n=Object(L.a)(Object(L.a)({},e.data),{},Object(U.a)({},t,a));e.onUpdate(Object(L.a)(Object(L.a)({},n),{},{invalid:!1}))}("target",t.target.value)}},!e.data.target&&i.a.createElement("option",{key:"",value:""}),(e.relativeOptions||[]).sort().map((function(e){return i.a.createElement("option",{key:e.value,value:e.value},e.label)})))):function(){var t=e.data.target?e.relativeOptions.find((function(t){return t.value===e.data.target})).label:"";return i.a.createElement("div",null,!e.hideControls&&i.a.createElement(q.a,{icon:B.a,opacity:"0.5",style:{cursor:"pointer"},pull:"right",className:"m-1"}),i.a.createElement("div",{style:{lineHeight:2,paddingLeft:"24px",textIndent:"-24px"}},i.a.createElement("span",{className:"mr-1 font-weight-bold"},e.fieldDefinition.name||e.fieldDefinition.id),i.a.createElement("span",{className:"mr-1"},"is equal to"),i.a.createElement("span",{className:"mr-1 mark"},t)))}()};var z=function(e){var t={comparator:[{value:"populated",display:"Populated"},{value:"not_populated",display:"Not Populated"},{value:"eq",display:"Equal To"},{value:"lt",display:"Less then"},{value:"lte",display:"Less than or equal to"},{value:"gt",display:"Greater than"},{value:"gte",display:"Greater than or equal to"}],compareTarget:[{value:"fixed",display:"Fixed Value of"}],offsetDir:[{value:"plus",display:"+"},{value:"minus",display:"-"}]},a=function(t,a){var n=Object(L.a)(Object(L.a)({},e.data),{},Object(U.a)({},t,a)),i=function(e){var t=-1===e.comparator.indexOf("populated")&&"fixed"===e.compareTo&&!/^\d+\.?\d+$/.test(e.fixedValue),a=e.unitCode&&e.unitCode.trim().indexOf(" ")>-1,n=e.unitSystem&&e.unitSystem.trim().indexOf(" ")>-1;return(t||a||n)&&{fixedValue:t,unitCode:a,unitSystem:n}}(n);e.onUpdate(Object(L.a)(Object(L.a)({},n),{},{invalid:i}))},n=function(e){return t[e].map((function(e){return i.a.createElement("option",{value:e.value,key:e.value},e.display)}))},r=e.data.comparator&&-1!==e.data.comparator.indexOf("populated");return e.edit?i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"my-2"},i.a.createElement("span",{className:"mr-1 font-weight-bold"},e.fieldDefinition.name||e.fieldDefinition.id),i.a.createElement("span",null,"is"),!e.hideControls&&i.a.createElement(q.a,{icon:B.b,opacity:"0.5",onClick:function(t){return e.onDelete(e.id)},style:{cursor:"pointer"},pull:"right"})),i.a.createElement("div",{className:"my-2"},i.a.createElement("select",{className:"form-control",value:e.data.comparator||"gt",onChange:function(e){return a("comparator",e.target.value)}},n("comparator"))),!r&&function(){var t=e.data.validate&&e.data.invalid&&e.data.invalid.fixedValue,r=e.data.validate&&e.data.invalid&&e.data.invalid.unitSystem,o=e.data.validate&&e.data.invalid&&e.data.invalid.unitCode;return i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"my-2 form-row"},i.a.createElement(w.a,null,i.a.createElement("select",{className:"form-control",value:e.data.compareTo||"fixed",onChange:function(e){return a("compareTo",e.target.value)}},n("compareTarget"),(e.relativeOptions||[]).sort().map((function(e){return i.a.createElement("option",{key:e.value,value:e.value},e.label)})))),(!e.data.compareTo||"fixed"===e.data.compareTo)&&i.a.createElement(w.a,null,i.a.createElement("input",Object(U.a)({type:"number",className:"form-control",required:!0,value:e.data.fixedValue||"",onChange:function(e){return a("fixedValue",e.target.value)}},"className",t?"is-invalid form-control":"form-control")))),"fixed"===e.data.compareTo&&i.a.createElement("div",{className:"form-row my-2"},i.a.createElement(w.a,{xs:"4"},i.a.createElement("input",Object(U.a)({className:"form-control",required:!1,value:e.data.unitCode||"",placeholder:"Unit Code",onChange:function(e){return a("unitCode",e.target.value)}},"className",o?"is-invalid form-control":"form-control"))),i.a.createElement(w.a,null,i.a.createElement("input",Object(U.a)({className:"form-control",required:!1,value:e.data.unitSystem||"",placeholder:"Unit System",onChange:function(e){return a("unitSystem",e.target.value)}},"className",r?"is-invalid form-control":"form-control")))))}(),!r&&"fixed"!==e.data.compareTo&&i.a.createElement("div",{className:"my-2 form-row"},i.a.createElement(w.a,null,i.a.createElement("select",{className:"form-control",value:e.data.offsetDir||"plus",onChange:function(e){return a("offsetDir",e.target.value)}},n("offsetDir"))),i.a.createElement(w.a,null,i.a.createElement("input",{type:"number",className:"form-control",value:e.data.offsetValue||"",required:!0,onChange:function(e){return a("offsetValue",e.target.value)}})))):function(){var a=function(e,a){return t[e].find((function(e){return e.value===a})).display},n=!r&&e.data.compareTo.indexOf(".")>-1&&e.relativeOptions.find((function(t){return t.value===e.data.compareTo})).label;return i.a.createElement("div",null,!e.hideControls&&i.a.createElement(q.a,{icon:B.a,opacity:"0.5",style:{cursor:"pointer"},pull:"right",className:"m-1"}),i.a.createElement("div",{style:{lineHeight:2}},i.a.createElement("span",{className:"mt-1 mr-1 font-weight-bold"},e.fieldDefinition.name||e.fieldDefinition.id),i.a.createElement("span",{className:"mt-1 mr-1"},"is"),i.a.createElement("span",{className:"mt-1 mr-1 mark"},a("comparator",e.data.comparator).toLowerCase()),!r&&"fixed"===e.data.compareTo&&i.a.createElement(i.a.Fragment,null,i.a.createElement("span",{className:"mt-1 mr-1 mark"},e.data.fixedValue),e.data.unitCode&&i.a.createElement("span",{className:"mt-1 mr-1 mark"},e.data.unitCode)),!r&&e.data.compareTo.indexOf(".")>-1&&i.a.createElement(i.a.Fragment,null,i.a.createElement("span",{className:"d-inline-block"},i.a.createElement("span",{className:"mt-1 mr-1 mark"},n)),function(){if(e.data.offsetValue)return i.a.createElement("span",{className:"mr-1 mt-1 mark"},a("offsetDir",e.data.offsetDir)," ",e.data.offsetValue)}())))}()};function J(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"date"===e.type?Object(L.a)(Object(L.a)(Object(L.a)({invalid:!1},{comparator:"gte",compareTo:"fixed",fixedValue:"2020-01-01",offsetUnit:"years",offsetDir:"plus",offsetValue:0,invalid:!1}),e.defaults||{}),t):"quantity"===e.type?Object(L.a)(Object(L.a)(Object(L.a)({invalid:!1},{comparator:"gte",compareTo:"fixed",fixedValue:"",offsetDir:"plus",offsetValue:0,invalid:!1}),e.defaults||{}),t):"coding"===e.type||"code"===e.type?Object(L.a)(Object(L.a)(Object(L.a)({invalid:!0},{invalid:{code:!0}}),e.defaults||{}),t):Object(L.a)(Object(L.a)({invalid:!0},e.defaults||{}),t)}var Y=function(e){var t=Object(n.useState)(e.edit),a=Object(p.a)(t,2),r=a[0],o=a[1],l=function(t,a){e.onUpdate(e.data.map((function(e,n){return t===n?a:e})))},c=function(t){if(1===e.data.length)return e.onDelete(e.id);e.onUpdate(e.data.filter((function(e,a){return t!==a})))};return i.a.createElement(H.a,{className:"shadow my-4"},r&&i.a.createElement($.a,{className:"text-right"},i.a.createElement(s.a,{variant:"outline-primary",size:"sm",onClick:function(){if(e.data.filter((function(e){return!!e.invalid})).length)return e.onUpdate(e.data.map((function(e){return Object(L.a)(Object(L.a)({},e),{},{validate:!0})})));o(!1)}},"Done")),e.data.map((function(t,a){return i.a.createElement($.a,{key:a,onClick:function(e){return!r&&o(!0)}},a>0&&i.a.createElement("div",{className:"text-center p-1 mb-1"},i.a.createElement("span",{className:"badge badge-pill badge-primary"},"or")),function(t,a){if("date"===e.fieldDefinition.type){var n=(e.relativeOptions||[]).filter((function(e){return"date"===e.fieldType}));return i.a.createElement(P,{data:t,fieldDefinition:e.fieldDefinition,relativeOptions:n,edit:r,onUpdate:function(e){return l(a,e)},onDelete:function(e){return c(a)},hideControls:!r&&a>0})}if("coding"===e.fieldDefinition.type||"code"===e.fieldDefinition.type)return i.a.createElement(M,{data:t,fieldDefinition:e.fieldDefinition,isCode:"code"===e.fieldDefinition.type,edit:r,onUpdate:function(e){return l(a,e)},onDelete:function(e){return c(a)},hideControls:!r&&a>0});if("fhirId"===e.fieldDefinition.type){var o=(e.relativeOptions||[]).filter((function(e){return"fhirId"===e.fieldType}));return i.a.createElement(Q,{data:t,relativeOptions:o,fieldDefinition:e.fieldDefinition,edit:r,onUpdate:function(e){return l(a,e)},onDelete:function(e){return c(a)},hideControls:!r&&a>0})}if("quantity"===e.fieldDefinition.type){var d=(e.relativeOptions||[]).filter((function(e){return"quantity"===e.fieldType}));return i.a.createElement(z,{data:t,relativeOptions:d,fieldDefinition:e.fieldDefinition,edit:r,onUpdate:function(e){return l(a,e)},onDelete:function(e){return c(a)},hideControls:!r&&a>0})}}(t,a))})),r&&i.a.createElement($.a,{className:"text-center"},i.a.createElement(s.a,{variant:"outline-primary",size:"sm",onClick:function(){e.onUpdate(e.data.concat([J(e.fieldDefinition)]))}},"Or...")))};var G=function(e){var t="none"!==e.retentionType&&"all"!==e.retentionType&&e.retentionSortField?e.retentionType+"."+e.retentionSortField:e.retentionType||"none",a=[{name:"Don't retain matching ".concat(e.definition.name," values"),value:"none"},{name:"Retain all matching ".concat(e.definition.name," values"),value:"all"}].concat(O.a.chain(e.definition.fields).filter((function(e){return"date"===e.type})).sortBy("name").map((function(e){return[{name:"Retain most recent match based on "+(e.name||e.id),value:"latest."+e.id},{name:"Retain earliest match based on "+(e.name||e.id),value:"earliest."+e.id}]})).flatten().value()),n=function(t){if(/^[a-zA-Z_]?[a-zA-Z0-9_]*$/.test(t.target.value)){var a=!t.target.value||(e.usedVars||[]).find((function(e){return e===t.target.value}));e.onChange({retentionVar:t.target.value,invalid:a})}},r=function(t){var a=t.target.value.split("."),n=Object(p.a)(a,2),i=n[0],r=n[1],o="none"!==i&&(!e.retentionVar||e.invalid);e.onChange({retentionType:i,retentionSortField:r,invalid:o})};return function(){var o=e.validate&&e.invalid,l=e.retentionVar||"";return i.a.createElement("div",{className:"container-fluid"},i.a.createElement("div",{className:"row my-1"},i.a.createElement("div",{className:"col"},i.a.createElement("select",{className:"form-control",value:t,onChange:r},a.map((function(e){return i.a.createElement("option",{key:e.value,value:e.value},e.name)}))))),"none"!==t&&i.a.createElement("div",{className:"form-row my-2"},i.a.createElement("div",{className:"col col-auto align-self-center"},"as"),i.a.createElement("div",{className:"col"},i.a.createElement("input",{value:l,placeholder:"Name",onChange:n,className:o?"is-invalid form-control":"form-control"}),o&&i.a.createElement("div",{className:"small text-danger mt-1"},"Note: variable name can't be blank and must be unique"))))}()};var W=function(e){var t=Object(n.useState)(e.data.name),a=Object(p.a)(t,2),r=a[0],o=a[1],d=Object(n.useState)(e.data.retention||{retentionType:"none"}),u=Object(p.a)(d,2),m=u[0],f=u[1],E=Object(n.useState)(e.data.rules||[]),b=Object(p.a)(E,2),g=b[0],h=b[1],y=Object(n.useState)(e.data.nextRuleId||0),O=Object(p.a)(y,2),N=O[0],j=O[1],T=Object(n.useState)(),I=Object(p.a)(T,2),D=I[0],C=I[1],k=Object(n.useState)(),x=Object(p.a)(k,2),_=x[0],S=x[1],w=Object(n.useState)(),R=Object(p.a)(w,2),A=R[0],U=R[1],q=Object(n.useState)(e.data.definition),B=Object(p.a)(q,2),P=B[0],M=B[1],Q=Object(n.useState)(),z=Object(p.a)(Q,2),W=z[0],X=z[1],Z=function(){var t=g.filter((function(e){return e.restrictions.filter((function(e){return!!e.invalid})).length}));t.length>0&&h(g.map((function(e){return Object(L.a)(Object(L.a)({},e),{},{edit:e.restrictions.filter((function(e){return!!e.invalid})).length>0,restrictions:e.restrictions.map((function(e){return Object(L.a)(Object(L.a)({},e),{},{validate:!0})}))})}))),!m.invalid&&r||X(!0),t.length>0||m.invalid||!r||e.onSave({name:r,retention:m,definition:P,parentId:e.parentId,id:e.id,nextRuleId:N,rules:g.map((function(e){var t=e.restrictions.map((function(e){e.validate,e.invalid;return Object(V.a)(e,["validate","invalid"])})),a=(e.edit,Object(V.a)(e,["edit"]));return Object(L.a)(Object(L.a)({},a),{},{restrictions:t})}))})},K=function(t,a){t&&t.preventDefault(),D&&!a&&P?S(!0):e.onClose()},ee=function(t,a){!a&&e.isReferenced?U(!0):e.onDelete()},te=function(){var t=e.relativeOptions.find((function(e){return"fhirId"===e.fieldType})),a=P.fields.filter((function(e){return"patient"!==e.name&&(t||"fhirId"!==e.type)}));return i.a.createElement("div",{className:"d-flex"},i.a.createElement(F.a,{title:"Add Rule",variant:"success",className:"mr-auto"},a.map((function(e){return i.a.createElement(c.a.Item,{onClick:function(t){return function(e){var t=P.fields.find((function(t){return t.id===e}));h(g.concat([{id:N,fieldId:e,edit:!0,restrictions:[J(t)]}])),j(N+1),C(!0)}(e.id)},key:e.id},e.name||e.id)}))),i.a.createElement(s.a,{variant:"outline-danger",className:"mr-2",onClick:ee},"Delete Block"),D&&i.a.createElement(s.a,{variant:"primary",className:"mr-1",onClick:Z},"Save Block"))},ae=function(){return g.map((function(t){var a=t.id,n=P.fields.find((function(e){return e.id===t.fieldId}));return i.a.createElement("div",{key:t.id},i.a.createElement(Y,{fieldDefinition:n,relativeOptions:e.relativeOptions,data:t.restrictions,edit:t.edit,onUpdate:function(e){return t=a,n=e,h(g.map((function(e){return e.id!==t?e:Object(L.a)(Object(L.a)({},e),{},{restrictions:n})}))),void C(!0);var t,n},onDelete:function(e){return t=a,h(g.filter((function(e){return e.id!==t}))),void C(!0);var t}}))}))},ne=g.filter((function(e){return e.restrictions.filter((function(e){return!(!e.invalid||!e.validate)})).length>0})).length>0||W&&!r||W&&m.invalid;return i.a.createElement(v.a,{backdrop:"static",show:!0,animation:!1,onHide:K,size:"lg"},P?i.a.createElement(i.a.Fragment,null,i.a.createElement(v.a.Header,{closeButton:!0},i.a.createElement(v.a.Title,{className:"d-flex flex-grow-1"},i.a.createElement(l.a.Control,{autoFocus:!0,placeholder:"Name",value:r||"",className:W&&!r?"is-invalid":"",onChange:function(e){o(e.target.value),C(!0)}}))),i.a.createElement(v.a.Body,null,i.a.createElement("p",null,"Block Type: ",P.name," ",i.a.createElement("small",null,"(",P.version,")")),_&&i.a.createElement("div",{className:"alert alert-danger text-center mb-4"},"You have unsaved changes -\xa0",i.a.createElement("a",{href:"#",className:"alert-link",onClick:function(e){return K(e,!0)}},"discard?")),A&&i.a.createElement("div",{className:"alert alert-danger text-center mb-4"},"Other blocks reference this block -\xa0",i.a.createElement("a",{href:"#",className:"alert-link",onClick:function(e){return ee(0,!0)}},"delete anyway?")),ne&&i.a.createElement("div",{className:"alert alert-danger text-center mb-4"},"Please fix the highlighted errors"),te(),ae()),i.a.createElement(v.a.Footer,null,i.a.createElement(G,Object.assign({},m,{definition:P,usedVars:e.usedVars,validate:W,onChange:function(e){f(Object(L.a)(Object(L.a)({},m),e)),C(!0)},edit:!0})))):i.a.createElement(i.a.Fragment,null,i.a.createElement(v.a.Header,{closeButton:!0},i.a.createElement(v.a.Title,null,"Block Type")),i.a.createElement(v.a.Body,null,i.a.createElement(H.a,null,e.definitions.map((function(e,t){return i.a.createElement($.a,{key:t,action:!0,onClick:function(t){o(e.name),M(e)}},e.name)}))))))};var X=function(e){var t=Object(f.b)("blocks","definitions","patients"),a=t.dispatch,r=t.blocks,o=t.definitions,l=t.patients,d=Object(n.useState)(),u=Object(p.a)(d,2),m=u[0],v=u[1],E={},b=r.concat(r.filter((function(e){return!r.find((function(t){return t.parentId===e.id}))})).map((function(e){return{id:e.id+"-end",name:e.exclude?"Exclude":"Include",parentId:e.id,isLeaf:!0,patients:l}})));b.filter((function(e){return!b.find((function(t){return t.parentId===e.id}))})).forEach((function(e){return function e(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=b.find((function(e){return e.id===t}));E[t]?E[t].span=E[t].span+a:E[t]={id:t,span:a,name:n.name,retention:n.retention,parentId:n.parentId,isLeaf:n.isLeaf,patients:n.patients},n&&null!==n.parentId&&e(n.parentId,a)}(e.id)})),b.filter((function(e){return null===e.parentId})).forEach((function(e,t){return function e(t,a){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;E[t]=Object(L.a)(Object(L.a)({},E[t]),{},{id:t,row:a,col:n});var i=n;b.filter((function(e){return e.parentId===t})).forEach((function(t){e(t.id,a+1,i),i+=E[t.id].span}))}(e.id,1,1)}));var g=b.reduce((function(e,t){var a=E[t.id];return Math.max(e,a.col+a.span)}),0),h=b.reduce((function(e,t){return Math.max(e,E[t.id].row)}),0),y=function(e){a("block/upsert",{block:e,insertAbove:m&&m.insertAbove||void 0}),v(null)},N=function(){void 0!==m.id&&a("block/delete",m),v(null)};return i.a.createElement("div",null,i.a.createElement("div",{className:"container-fluid split"},i.a.createElement("table",{className:"m-4"},i.a.createElement("tbody",null,O.a.range(1,h+1).map((function(e){var t=0;return i.a.createElement("tr",{key:e,className:"",style:{height:"100%"}},O.a.range(1,g).map((function(a){if(!t){var n=O.a.find(E,(function(t){return t.row===e&&t.col===a}));return n?(t=n.span-1,function(e,t,a){var n="btn m-2 p-4 flex-grow-1 block-button text-dark "+(("Include"===a.name?"btn-outline-success":"Exclude"===a.name&&"btn-outline-danger")||"btn-outline-primary"),r=a.retention&&"none"!==a.retention.retentionType?"retain ".concat(a.retention.retentionType," as ").concat(a.retention.retentionVar):"",o=r?i.a.createElement("span",null,a.name,i.a.createElement("br",null),"\u2193",i.a.createElement("br",null),r):a.name;return i.a.createElement("td",{key:e+":"+t,colSpan:a.span,className:"text-center",style:{height:"1px"}},i.a.createElement("div",{className:"h-100 w-100 d-flex flex-column"},1!==e&&!a.isLeaf&&i.a.createElement("div",null,i.a.createElement(F.a,{title:"\u2193",size:"sm",variant:"outline-primary",className:"m-2 no-caret"},i.a.createElement(c.a.Item,{href:"#",onClick:function(e){return v({parentId:a.parentId})}},"Add Branch"),i.a.createElement(c.a.Item,{href:"#",onClick:function(e){return v({parentId:a.parentId,insertAbove:a.id})}},"Insert Block"))),a.isLeaf&&i.a.createElement("div",null,i.a.createElement(s.a,{size:"sm",variant:"outline-primary",className:"m-2",onClick:function(e){return v({parentId:a.parentId})}},"\u2193")),i.a.createElement("button",{className:n,onClick:function(e){a.isLeaf?y({id:a.parentId,exclude:"Exclude"!==a.name}):"root"===a.id||a.isLeaf||v({id:a.id,parentId:a.parentId})}},o),void 0!==a.patients&&!a.isLeaf&&i.a.createElement("div",null,i.a.createElement(A.a,{variant:"primary",size:"sm"},a.patients," ",1!==a.patients?"Patients":"Patient")),void 0!==a.patients&&a.isLeaf&&i.a.createElement("div",null,i.a.createElement(A.a,{variant:"success",size:"sm"},"Cohort:",i.a.createElement("br",null),a.patients," ",1!==a.patients?"Patients":"Patient"))))}(e,a,n)):i.a.createElement("td",{key:e+":"+a})}t-=1})))}))))),m&&function(){var e=r.find((function(e){return e.id===m.id}))||{},t=e.retention&&"none"!==e.retention.retentionType?e.retention.retentionVar:"",a=r.filter((function(e){return e.retention&&"none"!==e.retention.retentionType&&e.retention.retentionVar&&e.retention.retentionVar!==t})).map((function(e){return e.retention.retentionVar})),n=null!==e.parentId?function e(t,a){var n=[],i=a.find((function(e){return e.id===t}));return i.retention&&i.retention.retentionVar&&i.definition.fields.forEach((function(e){n.push({retentionVar:i.retention.retentionVar,fieldType:e.type,fieldName:e.name||e.id,value:[i.id,e.id].join("."),label:[i.retention.retentionVar,e.name||e.id].join(".")})})),null!==i.parentId?n.concat(e(i.parentId,a)):n}(m.parentId,r):[],l=r.find((function(e){return e.rules&&e.rules.find((function(e){return e.restrictions&&e.restrictions.find((function(e){return e.compareTo&&e.compareTo.split(".")[0]===m.id.toString()||e.target&&e.target.split(".")[0]===m.id.toString()}))}))}));return console.log(l),i.a.createElement(W,{id:m.id,parentId:m.parentId,data:e,definitions:o,usedVars:a,onClose:function(e){return v(null)},relativeOptions:n,onSave:y,onDelete:N,isReferenced:!!l})}())};var Z=function(){var e=this,t=Object(f.b)("view","hasTestConfig"),a=t.view,n=t.hasTestConfig,r=t.dispatch,o=function(e,t){t.preventDefault(),r("view/set",e)};return i.a.createElement("div",null,i.a.createElement(u.a,{bg:"info",variant:"dark"},i.a.createElement(u.a.Brand,{href:"#"},"FHIR Cohort Query Builder"),i.a.createElement(m.a,{className:"ml-auto"},n?i.a.createElement(l.a,{inline:!0},i.a.createElement(c.a,{as:d.a},i.a.createElement(s.a,{variant:"outline-light",onClick:o.bind(e,"test-run")},"Test Query"),i.a.createElement(c.a.Toggle,{split:!0,variant:"outline-light"}),i.a.createElement(c.a.Menu,null,i.a.createElement(c.a.Item,{onClick:o.bind(e,"test-configure")},"Change Data Source")))):i.a.createElement(s.a,{variant:"outline-light",onClick:o.bind(e,"test-configure")},"Test Query"),i.a.createElement(s.a,{variant:"outline-light",className:"ml-3",onClick:function(e){e.preventDefault(),r("view/set","export")}},"Export SQL"))),"export"===a&&i.a.createElement(R,null),i.a.createElement(_,{show:a&&0===a.indexOf("test"),mode:a}),i.a.createElement(X,null))},K=a(59),ee=a(67),te=[{name:"Lab Result - Numerical",version:"1.0.0.alpha",tableName:"Observation",patientIdField:"subject.reference_id_aa",fields:[{id:"status",type:"code",field:"status",editable:!0,options:[{values:[{code:"registered"}],name:"Registered"},{values:[{code:"preliminary"}],name:"Preliminary"},{values:[{code:"final"}],name:"Final"},{values:[{code:"amended"}],name:"Amended"},{values:[{code:"corrected"}],name:"- Corrected"},{values:[{code:"cancelled"}],name:"Cancelled"},{values:[{code:"entered-in-error"}],name:"Entered in Error"},{values:[{code:"unknown"}],name:"Unknown"}]},{id:"id",type:"fhirId",field:"id"},{id:"effectiveDateTimeStart",type:"date",field:"effectiveDateTime_aa.start"},{id:"effectiveDateTimeEnd",type:"date",field:"effectiveDateTime_aa.end"},{id:"valueQuantity",type:"quantity",field:"valueQuantity"},{id:"code",type:"coding",field:"code.coding[]"},{id:"dataAbsentReason",type:"coding",field:"dataAbsentReason.coding",editable:!0,options:[{values:[{code:"unknown"}],name:"Unknown"},{values:[{code:"asked-unknown"}],name:"-  Asked But Unknown"},{values:[{code:"temp-unknown"}],name:"-  Temporarily Unknown"},{values:[{code:"not-asked"}],name:"  Not Asked"},{values:[{code:"asked-declined"}],name:"-  Asked But Declined"},{values:[{code:"masked"}],name:"Masked"},{values:[{code:"not-applicable"}],name:"Not Applicable"},{values:[{code:"unsupported"}],name:"Unsupported"},{values:[{code:"as-text"}],name:"As Text"},{values:[{code:"error"}],name:"Error"},{values:[{code:"not-a-number"}],name:"-  Not a Number"},{values:[{code:"negative-infinity"}],name:"-  Negative Infinity"},{values:[{code:"positive-infinity"}],name:"-  Positive Infinity"},{values:[{code:"not-performed"}],name:"Not Performed"},{values:[{code:"not-permitted"}],name:"Not Permitted"}]}]},{name:"Condition",version:"1.0.0.alpha",tableName:"Condition",patientIdField:"subject.reference_id_aa",fields:[{id:"id",type:"fhirId",field:"id"},{id:"clinicalStatus",type:"coding",field:"clinicalStatus.coding[]",editable:!1,options:[{values:[{code:"active"}],name:"Active"},{values:[{code:"recurrence"}],name:"- Recurrence"},{values:[{code:"relapse"}],name:"- Relapse"},{values:[{code:"inactive"}],name:"Inactive"},{values:[{code:"remission"}],name:"- Remission"},{values:[{code:"resolved"}],name:"- Resolved"}]},{id:"verificationStatus",type:"coding",field:"verificationStatus.coding[]",editable:!1,options:[{values:[{code:"unconfirmed"}],name:"Unconfirmed"},{values:[{code:"provisional"}],name:"- Provisional"},{values:[{code:"differential"}],name:"- Differential"},{values:[{code:"confirmed"}],name:"Confirmed"},{values:[{code:"refuted"}],name:"Refuted"},{values:[{code:"entered-in-error"}],name:"Entered in Error"}]},{id:"category",type:"coding",field:"category[].coding[]",editable:!1,options:[{values:[{code:"problem-list-item"}],name:"Problem List Item"},{values:[{code:"encounter-diagnosis"}],name:"Encounter Diagnosis"},{values:[{code:"health-concern"}],name:"Health Concern"}]},{id:"code",type:"coding",field:"code.coding[]"}]},{name:"Demographics",version:"1.0.0.alpha",tableName:"Patient",patientIdField:"id",fields:[{id:"gender",type:"code",field:"gender",editable:!1,options:[{values:[{code:"male"}],name:"Male"},{values:[{code:"female"}],name:"Female"},{values:[{code:"other"}],name:"Other"},{values:[{code:"unknown"}],name:"Unknown"}]},{id:"birthDate",type:"date",field:"birthDate"}]}],ae={nextId:7,definitions:te,view:"blocks",blocks:[{id:"root",name:"All Patients",parentId:null,definition:{tableName:"Patient",patientIdField:"id"}},{id:0,nextRuleId:0,parentId:"root",name:"Demographics",definition:te[2],retention:{retentionType:"all",retentionVar:"pt"}},{name:"DM Dx",definition:te[1],parentId:0,id:1,nextRuleId:1,rules:[{id:0,fieldId:"code",restrictions:[{name:"SNOMED DM",system:"http://snomed.info/sct",code:"105401000119101,106281000119103,10754881000119104,111307005,111552007,123763000,127012008,1481000119100,190330002,190331003,190368000,190372001,190389009,190406000,190407009,190410002,190411003,190412005,199223000,199225007,199226008,199227004,199228009,199229001,199230006,199231005,23045005,237599002,237600004,237601000,237604008,237613005,237618001,237619009,237627000,237651005,24203005,2751001,28032008,31321000119102,313435000,313436004,314771006,314893005,314902007,314903002,314904008,33559001,359642000,368521000119107,408539000,426705001,426875007,427089005,42954008,44054006,445260006,46635009,4783006,51002006,530558861000132104,57886004,59079001,5969009,609561005,609562003,609563008,609564002,609566000,609567009,609568004,609569007,609570008,609571007,609572000,609573005,609574004,609575003,609576002,609577006,609578001,70694009,709147009,710815001,716362006,71791000119104,719216001,720519003,722454003,724136006,73211009,733072002,734022008,75524006,75682002,76751001,81531005,8801005,91352004,9859006"}]}]},{name:"Most Recent A1C",retention:{retentionType:"latest",retentionSortField:"effectiveDateTimeEnd",retentionVar:"a1c_latest"},definition:te[0],parentId:1,id:2,nextRuleId:2,rules:[{id:0,fieldId:"status",restrictions:[{option:"Final"},{option:"Amended"},{option:"- Corrected"}]},{id:1,fieldId:"code",restrictions:[{system:"http://loinc.org",code:"4548-4"}]}]},{name:"Most Recent A1C Elevated",definition:te[0],parentId:2,id:3,nextRuleId:2,rules:[{id:0,fieldId:"id",restrictions:[{target:"2.id"}]},{id:1,fieldId:"valueQuantity",restrictions:[{comparator:"gte",compareTo:"fixed",fixedValue:"7",offsetDir:"plus",offsetValue:0}]}]},{name:"Penultimate A1C",retention:{retentionType:"latest",retentionSortField:"effectiveDateTimeEnd",retentionVar:"a1c_prev"},definition:te[0],parentId:3,id:4,nextRuleId:4,rules:[{id:0,fieldId:"status",restrictions:[{option:"Final"},{option:"Amended"},{option:"- Corrected"}]},{id:1,fieldId:"effectiveDateTimeStart",restrictions:[{comparator:"lt",compareTo:"2.effectiveDateTimeStart",offsetUnit:"months",offsetDir:"minus",offsetValue:"1"}]},{id:2,fieldId:"effectiveDateTimeStart",restrictions:[{comparator:"gte",compareTo:"0.birthDate",fixedValue:"2020-01-01",offsetUnit:"years",offsetDir:"plus",offsetValue:"18"}]},{id:3,fieldId:"code",restrictions:[{system:"http://loinc.org",code:"4548-4"}]}]},{name:"Penultimate A1C Elevated",definition:te[0],parentId:4,id:5,nextRuleId:2,rules:[{id:0,fieldId:"id",restrictions:[{target:"4.id"}]},{id:1,fieldId:"valueQuantity",restrictions:[{comparator:"gte",compareTo:"fixed",fixedValue:"7",offsetDir:"plus",offsetValue:0}]}]},{name:"HTN Dx",definition:te[1],parentId:"root",id:7,nextRuleId:2,exclude:!0,rules:[{id:0,fieldId:"clinicalStatus",restrictions:[{option:"Active"}]},{id:1,fieldId:"verificationStatus",restrictions:[{option:"Confirmed"}]},{id:2,fieldId:"code",restrictions:[{system:"http://snomed.info/sct",name:"SNOMED",code:"10725009, 10964002, 1201005, 123799005, 59621000"},{name:"ICD-9",system:"http://hl7.org/fhir/ValueSet/icd-9",code:"401.1, 401.9"}]}]}]},ne={nextId:1,definitions:te,view:"blocks",hasTestConfig:!1,blocks:[{id:"root",name:"All Patients",parentId:null,definition:{tableName:"Patient",patientIdField:"id"}}]},ie=Object(ee.a)([function(e){e.on("@init",(function(){return/example=true/.test(window.location.search)?ae:ne})),e.on("block/upsert",(function(e,t){var a=e.nextId,n=e.blocks,i=t.block,r=t.insertAbove,o=void 0===i.id?{nextId:a+1,patients:void 0,blocks:n.map((function(e){return e.id===r?Object(L.a)(Object(L.a)({},e),{},{parentId:a+1}):Object(L.a)(Object(L.a)({},e),{},{patients:void 0})})).concat([Object(L.a)(Object(L.a)({},i),{},{id:a+1})])}:{patients:void 0,blocks:n.map((function(e){return i.id!==e.id?Object(L.a)(Object(L.a)({},e),{},{patients:void 0}):Object(L.a)(Object(L.a)(Object(L.a)({},e),i),{},{patients:void 0})}))};return console.log(o),o})),e.on("block/delete",(function(e,t){var a=e.blocks,n=t.id,i=t.parentId;return{patients:void 0,blocks:a.map((function(e){return e.parentId===n?Object(L.a)(Object(L.a)({},e),{},{parentId:i,patients:void 0}):Object(L.a)(Object(L.a)({},e),{},{patients:void 0})})).filter((function(e){return e.id!==n})).map((function(e){return Object(L.a)(Object(L.a)({},e),{},{rules:e.rules&&e.rules.map((function(e){return Object(L.a)(Object(L.a)({},e),{},{restrictions:e.restrictions&&e.restrictions.filter((function(e){return(!e.target||e.target.split(".")[0]!==n.toString())&&(!e.compareTo||e.compareTo.split(".")[0]!==n.toString())}))})}))})}))}})),e.on("view/set",(function(e,t){return Object(K.a)(e),{view:t}})),e.on("hasTestConfig/set",(function(e,t){return Object(K.a)(e),{hasTestConfig:t}})),e.on("patients/set",(function(e,t){var a=e.blocks;if(!t)return{patients:void 0,blocks:a.map((function(e){return Object(L.a)(Object(L.a)({},e),{},{patients:void 0})}))};var n=t[0].values.reduce((function(e,t){return Object(L.a)(Object(L.a)({},e),{},Object(U.a)({},t[0],t[1]))}),{});return{patients:n.result,blocks:a.map((function(e){return Object(L.a)(Object(L.a)({},e),{},{patients:n[e.id.toString()]})}))}}))}]);o.a.render(i.a.createElement(i.a.StrictMode,null,i.a.createElement(f.a.Provider,{value:ie},i.a.createElement(Z,null))),document.getElementById("root"))}},[[75,1,3]]]);
//# sourceMappingURL=main.798af84a.chunk.js.map